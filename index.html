<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Requirements Management System</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif; }
        .folder-item { cursor: pointer; user-select: none; }
        .folder-item:hover { background-color: #f3f4f6; }
        .folder-expanded { font-weight: 600; }
        .folder-children { padding-left: 20px; border-left: 1px solid #e5e7eb; margin-left: 8px; }
        .test-run-card { transition: all 0.2s; }
        .test-run-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .status-badge { display: inline-block; padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .status-pass { background-color: #d1fae5; color: #065f46; }
        .status-fail { background-color: #fee2e2; color: #991b1b; }
        .status-block { background-color: #fef3c7; color: #92400e; }
        .status-pending { background-color: #e0e7ff; color: #3730a3; }
        .progress-bar { height: 8px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.3s ease; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; border-radius: 8px; max-width: 600px; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
        const { createElement: h, useState, useEffect, useCallback, useMemo } = React;
        
        // Lucide React Icons
        const Icon = ({ size = 24, d, children, className = '', ...props }) => 
          h('svg', {
            xmlns: 'http://www.w3.org/2000/svg',
            width: size,
            height: size,
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: 2,
            strokeLinecap: 'round',
            strokeLinejoin: 'round',
            className,
            ...props
          }, d || children);

        const Menu = ({ size }) => Icon({ size, d: [h('line', { key: 1, x1: 4, y1: 12, x2: 20, y2: 12 }), h('line', { key: 2, x1: 4, y1: 6, x2: 20, y2: 6 }), h('line', { key: 3, x1: 4, y1: 18, x2: 20, y2: 18 })] });
        const Plus = ({ size }) => Icon({ size, d: [h('line', { key: 1, x1: 12, y1: 5, x2: 12, y2: 19 }), h('line', { key: 2, x1: 5, y1: 12, x2: 19, y2: 12 })] });
        const FileText = ({ size }) => Icon({ size, d: [h('path', { key: 1, d: 'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z' }), h('polyline', { key: 2, points: '14 2 14 8 20 8' }), h('line', { key: 3, x1: 16, y1: 13, x2: 8, y2: 13 }), h('line', { key: 4, x1: 16, y1: 17, x2: 8, y2: 17 }), h('polyline', { key: 5, points: '10 9 9 9 8 9' })] });
        const CheckSquare = ({ size }) => Icon({ size, d: [h('polyline', { key: 1, points: '9 11 12 14 22 4' }), h('path', { key: 2, d: 'M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11' })] });
        const AlertCircle = ({ size }) => Icon({ size, d: [h('circle', { key: 1, cx: 12, cy: 12, r: 10 }), h('line', { key: 2, x1: 12, y1: 8, x2: 12, y2: 12 }), h('line', { key: 3, x1: 12, y1: 16, x2: 12.01, y2: 16 })] });
        const Target = ({ size }) => Icon({ size, d: [h('circle', { key: 1, cx: 12, cy: 12, r: 10 }), h('circle', { key: 2, cx: 12, cy: 12, r: 6 }), h('circle', { key: 3, cx: 12, cy: 12, r: 2 })] });
        const Filter = ({ size }) => Icon({ size, d: [h('polygon', { key: 1, points: '22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3' })] });
        const Search = ({ size }) => Icon({ size, d: [h('circle', { key: 1, cx: 11, cy: 11, r: 8 }), h('line', { key: 2, x1: 21, y1: 21, x2: 16.65, y2: 16.65 })] });
        const User = ({ size }) => Icon({ size, d: [h('path', { key: 1, d: 'M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2' }), h('circle', { key: 2, cx: 12, cy: 7, r: 4 })] });
        const Link = ({ size }) => Icon({ size, d: [h('path', { key: 1, d: 'M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71' }), h('path', { key: 2, d: 'M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71' })] });
        const GitBranch = ({ size }) => Icon({ size, d: [h('line', { key: 1, x1: 6, y1: 3, x2: 6, y2: 15 }), h('circle', { key: 2, cx: 18, cy: 6, r: 3 }), h('circle', { key: 3, cx: 6, cy: 18, r: 3 }), h('path', { key: 4, d: 'M18 9a9 9 0 0 1-9 9' })] });
        const Upload = ({ size }) => Icon({ size, d: [h('path', { key: 1, d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }), h('polyline', { key: 2, points: '17 8 12 3 7 8' }), h('line', { key: 3, x1: 12, y1: 3, x2: 12, y2: 15 })] });
        const Download = ({ size }) => Icon({ size, d: [h('path', { key: 1, d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }), h('polyline', { key: 2, points: '7 10 12 15 17 10' }), h('line', { key: 3, x1: 12, y1: 15, x2: 12, y2: 3 })] });
        const X = ({ size }) => Icon({ size, d: [h('line', { key: 1, x1: 18, y1: 6, x2: 6, y2: 18 }), h('line', { key: 2, x1: 6, y1: 6, x2: 18, y2: 18 })] });
        const ChevronDown = ({ size }) => Icon({ size, d: [h('polyline', { key: 1, points: '6 9 12 15 18 9' })] });
        const ChevronRight = ({ size }) => Icon({ size, d: [h('polyline', { key: 1, points: '9 18 15 12 9 6' })] });
        const Folder = ({ size }) => Icon({ size, d: [h('path', { key: 1, d: 'M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z' })] });
        const FolderOpen = ({ size }) => Icon({ size, d: [h('path', { key: 1, d: 'M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z' }), h('path', { key: 2, d: 'M2 8v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2H8' })] });
        const Play = ({ size }) => Icon({ size, d: [h('polygon', { key: 1, points: '5 3 19 12 5 21 5 3' })] });
        const CheckCircle = ({ size }) => Icon({ size, d: [h('path', { key: 1, d: 'M22 11.08V12a10 10 0 1 1-5.93-9.14' }), h('polyline', { key: 2, points: '22 4 12 14.01 9 11.01' })] });
        const XCircle = ({ size }) => Icon({ size, d: [h('circle', { key: 1, cx: 12, cy: 12, r: 10 }), h('line', { key: 2, x1: 15, y1: 9, x2: 9, y2: 15 }), h('line', { key: 3, x1: 9, y1: 9, x2: 15, y2: 15 })] });
        const Clock = ({ size }) => Icon({ size, d: [h('circle', { key: 1, cx: 12, cy: 12, r: 10 }), h('polyline', { key: 2, points: '12 6 12 12 16 14' })] });
        const HelpCircle = ({ size }) => Icon({ size, d: [h('circle', { key: 1, cx: 12, cy: 12, r: 10 }), h('path', { key: 2, d: 'M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3' }), h('line', { key: 3, x1: 12, y1: 17, x2: 12.01, y2: 17 })] });
        const Calendar = ({ size }) => Icon({ size, d: [h('rect', { key: 1, x: 3, y: 4, width: 18, height: 18, rx: 2, ry: 2 }), h('line', { key: 2, x1: 16, y1: 2, x2: 16, y2: 6 }), h('line', { key: 3, x1: 8, y1: 2, x2: 8, y2: 6 }), h('line', { key: 4, x1: 3, y1: 10, x2: 21, y2: 10 })] });
        const List = ({ size }) => Icon({ size, d: [h('line', { key: 1, x1: 8, y1: 6, x2: 21, y2: 6 }), h('line', { key: 2, x1: 8, y1: 12, x2: 21, y2: 12 }), h('line', { key: 3, x1: 8, y1: 18, x2: 21, y2: 18 }), h('line', { key: 4, x1: 3, y1: 6, x2: 3.01, y2: 6 }), h('line', { key: 5, x1: 3, y1: 12, x2: 3.01, y2: 12 }), h('line', { key: 6, x1: 3, y1: 18, x2: 3.01, y2: 18 })] });

        // Database simulation
        const DB_NAME = 'RequirementsDB';
        const DB_VERSION = 3;

        const initDB = () => {
          return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
            
            request.onupgradeneeded = (event) => {
              const db = event.target.result;
              
              if (!db.objectStoreNames.contains('items')) {
                const itemStore = db.createObjectStore('items', { keyPath: 'id' });
                itemStore.createIndex('type', 'type', { unique: false });
                itemStore.createIndex('status', 'status', { unique: false });
                itemStore.createIndex('projectId', 'projectId', { unique: false });
              }
              
              if (!db.objectStoreNames.contains('relationships')) {
                db.createObjectStore('relationships', { keyPath: 'id' });
              }
              
              if (!db.objectStoreNames.contains('projects')) {
                db.createObjectStore('projects', { keyPath: 'id' });
              }
              
              if (!db.objectStoreNames.contains('auditLogs')) {
                const auditStore = db.createObjectStore('auditLogs', { keyPath: 'id' });
                auditStore.createIndex('itemId', 'itemId', { unique: false });
                auditStore.createIndex('timestamp', 'timestamp', { unique: false });
              }

              if (!db.objectStoreNames.contains('testRuns')) {
                const testRunStore = db.createObjectStore('testRuns', { keyPath: 'id' });
                testRunStore.createIndex('status', 'status', { unique: false });
                testRunStore.createIndex('createdAt', 'createdAt', { unique: false });
              }

              if (!db.objectStoreNames.contains('testResults')) {
                const testResultStore = db.createObjectStore('testResults', { keyPath: 'id' });
                testResultStore.createIndex('runId', 'runId', { unique: false });
                testResultStore.createIndex('testCaseId', 'testCaseId', { unique: false });
              }

              if (!db.objectStoreNames.contains('folders')) {
                const folderStore = db.createObjectStore('folders', { keyPath: 'id' });
                folderStore.createIndex('parentId', 'parentId', { unique: false });
              }
            };
          });
        };

        const dbOperation = (storeName, mode, operation) => {
          return initDB().then(db => {
            return new Promise((resolve, reject) => {
              const transaction = db.transaction([storeName], mode);
              const store = transaction.objectStore(storeName);
              const request = operation(store);
              
              request.onsuccess = () => resolve(request.result);
              request.onerror = () => reject(request.error);
            });
          });
        };

        // Folder Management Component
        const FolderTree = ({ folders, items, onSelectItem, selectedItemId, onCreateFolder, onDeleteFolder }) => {
          const [expandedFolders, setExpandedFolders] = useState(new Set());

          const toggleFolder = (folderId) => {
            setExpandedFolders(prev => {
              const next = new Set(prev);
              if (next.has(folderId)) {
                next.delete(folderId);
              } else {
                next.add(folderId);
              }
              return next;
            });
          };

          const getFolderTree = () => {
            const folderMap = new Map();
            folders.forEach(folder => folderMap.set(folder.id, { ...folder, children: [], items: [] }));
            
            const rootFolders = [];
            folders.forEach(folder => {
              const node = folderMap.get(folder.id);
              if (folder.parentId) {
                const parent = folderMap.get(folder.parentId);
                if (parent) parent.children.push(node);
              } else {
                rootFolders.push(node);
              }
            });

            items.forEach(item => {
              if (item.folderId) {
                const folder = folderMap.get(item.folderId);
                if (folder) folder.items.push(item);
              }
            });

            return rootFolders;
          };

          const renderFolder = (folder) => {
            const isExpanded = expandedFolders.has(folder.id);
            const hasChildren = folder.children.length > 0 || folder.items.length > 0;

            return h('div', { key: folder.id, className: 'mb-1' },
              h('div', {
                className: `folder-item flex items-center gap-2 px-3 py-2 rounded ${isExpanded ? 'folder-expanded' : ''}`,
                onClick: () => hasChildren && toggleFolder(folder.id)
              },
                hasChildren && (isExpanded ? h(ChevronDown, { size: 16 }) : h(ChevronRight, { size: 16 })),
                h(isExpanded ? FolderOpen : Folder, { size: 16 }),
                h('span', { className: 'flex-1' }, folder.name),
                h('span', { className: 'text-xs text-gray-500' }, folder.items.length)
              ),
              isExpanded && hasChildren && h('div', { className: 'folder-children' },
                folder.children.map(child => renderFolder(child)),
                folder.items.map(item => 
                  h('div', {
                    key: item.id,
                    className: `flex items-center gap-2 px-3 py-2 rounded cursor-pointer hover:bg-gray-100 ${selectedItemId === item.id ? 'bg-blue-50 text-blue-600' : ''}`,
                    onClick: () => onSelectItem(item)
                  },
                    h(getIconForType(item.type), { size: 14 }),
                    h('span', { className: 'text-sm truncate flex-1' }, item.title),
                    h('span', { className: `status-badge status-${item.status.toLowerCase()}` }, item.status)
                  )
                )
              )
            );
          };

          const getIconForType = (type) => {
            switch (type) {
              case 'epic': return Target;
              case 'requirement': return FileText;
              case 'test_case': return CheckSquare;
              case 'defect': return AlertCircle;
              default: return FileText;
            }
          };

          const unorganizedItems = items.filter(item => !item.folderId);
          const tree = getFolderTree();

          return h('div', { className: 'h-full overflow-y-auto' },
            tree.map(folder => renderFolder(folder)),
            unorganizedItems.length > 0 && h('div', { className: 'mt-4 border-t pt-4' },
              h('div', { className: 'px-3 py-2 text-sm font-semibold text-gray-500' }, 'Unorganized'),
              unorganizedItems.map(item =>
                h('div', {
                  key: item.id,
                  className: `flex items-center gap-2 px-3 py-2 rounded cursor-pointer hover:bg-gray-100 ${selectedItemId === item.id ? 'bg-blue-50 text-blue-600' : ''}`,
                  onClick: () => onSelectItem(item)
                },
                  h(getIconForType(item.type), { size: 14 }),
                  h('span', { className: 'text-sm truncate flex-1' }, item.title),
                  h('span', { className: `status-badge status-${item.status.toLowerCase()}` }, item.status)
                )
              )
            )
          );
        };

        // Test Run Components
        const TestRunCard = ({ run, onClick }) => {
          const getStatusColor = (status) => {
            switch (status) {
              case 'completed': return 'bg-green-100 text-green-800';
              case 'in_progress': return 'bg-blue-100 text-blue-800';
              case 'planned': return 'bg-gray-100 text-gray-800';
              default: return 'bg-gray-100 text-gray-800';
            }
          };

          const calculateProgress = () => {
            const total = run.totalTests || 0;
            const completed = (run.passed || 0) + (run.failed || 0) + (run.blocked || 0);
            return total > 0 ? (completed / total) * 100 : 0;
          };

          return h('div', {
            className: 'test-run-card bg-white rounded-lg shadow p-4 cursor-pointer border border-gray-200',
            onClick
          },
            h('div', { className: 'flex items-start justify-between mb-3' },
              h('div', { className: 'flex-1' },
                h('h3', { className: 'font-semibold text-lg mb-1' }, run.name),
                h('p', { className: 'text-sm text-gray-600' }, run.description)
              ),
              h('span', { className: `px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(run.status)}` }, 
                run.status.replace('_', ' ').toUpperCase()
              )
            ),
            h('div', { className: 'space-y-2' },
              h('div', { className: 'progress-bar' },
                h('div', {
                  className: 'progress-fill bg-blue-500',
                  style: { width: `${calculateProgress()}%` }
                })
              ),
              h('div', { className: 'grid grid-cols-4 gap-2 text-center text-sm' },
                h('div', {},
                  h('div', { className: 'font-semibold text-gray-700' }, run.totalTests || 0),
                  h('div', { className: 'text-xs text-gray-500' }, 'Total')
                ),
                h('div', {},
                  h('div', { className: 'font-semibold text-green-600' }, run.passed || 0),
                  h('div', { className: 'text-xs text-gray-500' }, 'Passed')
                ),
                h('div', {},
                  h('div', { className: 'font-semibold text-red-600' }, run.failed || 0),
                  h('div', { className: 'text-xs text-gray-500' }, 'Failed')
                ),
                h('div', {},
                  h('div', { className: 'font-semibold text-yellow-600' }, run.blocked || 0),
                  h('div', { className: 'text-xs text-gray-500' }, 'Blocked')
                )
              ),
              h('div', { className: 'flex items-center justify-between text-xs text-gray-500 mt-2 pt-2 border-t' },
                h('span', {}, `Created: ${new Date(run.createdAt).toLocaleDateString()}`),
                run.completedAt && h('span', {}, `Completed: ${new Date(run.completedAt).toLocaleDateString()}`)
              )
            )
          );
        };

        const TestRunExecution = ({ run, testCases, results, onUpdateResult, onClose }) => {
          const [currentIndex, setCurrentIndex] = useState(0);
          const [notes, setNotes] = useState('');
          const [filter, setFilter] = useState('all');

          const currentTestCase = testCases[currentIndex];
          const currentResult = results.find(r => r.testCaseId === currentTestCase?.id);

          const handleStatusUpdate = (status) => {
            if (currentTestCase) {
              onUpdateResult(currentTestCase.id, status, notes);
              setNotes('');
              if (currentIndex < testCases.length - 1) {
                setCurrentIndex(currentIndex + 1);
              }
            }
          };

          const filteredCases = useMemo(() => {
            if (filter === 'all') return testCases;
            const statusMap = { pending: null, pass: 'pass', fail: 'fail', block: 'block' };
            return testCases.filter(tc => {
              const result = results.find(r => r.testCaseId === tc.id);
              return filter === 'pending' ? !result : result?.status === statusMap[filter];
            });
          }, [filter, testCases, results]);

          const stats = useMemo(() => {
            const passed = results.filter(r => r.status === 'pass').length;
            const failed = results.filter(r => r.status === 'fail').length;
            const blocked = results.filter(r => r.status === 'block').length;
            const pending = testCases.length - results.length;
            return { passed, failed, blocked, pending };
          }, [results, testCases]);

          return h('div', { className: 'modal-overlay', onClick: onClose },
            h('div', {
              className: 'modal-content w-full max-w-4xl p-6',
              onClick: (e) => e.stopPropagation()
            },
              h('div', { className: 'flex items-center justify-between mb-6' },
                h('h2', { className: 'text-2xl font-bold' }, run.name),
                h('button', {
                  onClick: onClose,
                  className: 'text-gray-400 hover:text-gray-600'
                }, h(X, { size: 24 }))
              ),
              
              h('div', { className: 'grid grid-cols-4 gap-4 mb-6' },
                h('div', { className: 'bg-gray-50 p-4 rounded-lg' },
                  h('div', { className: 'text-2xl font-bold text-gray-700' }, stats.pending),
                  h('div', { className: 'text-sm text-gray-500' }, 'Pending')
                ),
                h('div', { className: 'bg-green-50 p-4 rounded-lg' },
                  h('div', { className: 'text-2xl font-bold text-green-600' }, stats.passed),
                  h('div', { className: 'text-sm text-gray-500' }, 'Passed')
                ),
                h('div', { className: 'bg-red-50 p-4 rounded-lg' },
                  h('div', { className: 'text-2xl font-bold text-red-600' }, stats.failed),
                  h('div', { className: 'text-sm text-gray-500' }, 'Failed')
                ),
                h('div', { className: 'bg-yellow-50 p-4 rounded-lg' },
                  h('div', { className: 'text-2xl font-bold text-yellow-600' }, stats.blocked),
                  h('div', { className: 'text-sm text-gray-500' }, 'Blocked')
                )
              ),

              h('div', { className: 'mb-4 flex gap-2' },
                ['all', 'pending', 'pass', 'fail', 'block'].map(f =>
                  h('button', {
                    key: f,
                    onClick: () => setFilter(f),
                    className: `px-4 py-2 rounded ${filter === f ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`
                  }, f.charAt(0).toUpperCase() + f.slice(1))
                )
              ),

              currentTestCase && h('div', { className: 'bg-white border rounded-lg p-6 mb-6' },
                h('div', { className: 'flex items-start justify-between mb-4' },
                  h('div', { className: 'flex-1' },
                    h('h3', { className: 'text-xl font-semibold mb-2' }, currentTestCase.title),
                    h('p', { className: 'text-gray-600 mb-4' }, currentTestCase.description)
                  ),
                  currentResult && h('span', {
                    className: `status-badge status-${currentResult.status}`
                  }, currentResult.status.toUpperCase())
                ),

                currentTestCase.preconditions && h('div', { className: 'mb-4' },
                  h('h4', { className: 'font-semibold mb-2' }, 'Preconditions:'),
                  h('p', { className: 'text-gray-700' }, currentTestCase.preconditions)
                ),

                currentTestCase.steps && h('div', { className: 'mb-4' },
                  h('h4', { className: 'font-semibold mb-2' }, 'Test Steps:'),
                  h('ol', { className: 'list-decimal list-inside space-y-1' },
                    currentTestCase.steps.split('\n').map((step, i) =>
                      h('li', { key: i, className: 'text-gray-700' }, step)
                    )
                  )
                ),

                currentTestCase.expected && h('div', { className: 'mb-4' },
                  h('h4', { className: 'font-semibold mb-2' }, 'Expected Result:'),
                  h('p', { className: 'text-gray-700' }, currentTestCase.expected)
                ),

                h('div', { className: 'mb-4' },
                  h('label', { className: 'block text-sm font-medium mb-2' }, 'Execution Notes:'),
                  h('textarea', {
                    value: notes,
                    onChange: (e) => setNotes(e.target.value),
                    className: 'w-full border rounded p-2 h-24',
                    placeholder: 'Add any notes about this test execution...'
                  })
                ),

                h('div', { className: 'flex gap-3' },
                  h('button', {
                    onClick: () => handleStatusUpdate('pass'),
                    className: 'flex-1 bg-green-500 text-white px-4 py-3 rounded font-semibold hover:bg-green-600 flex items-center justify-center gap-2'
                  }, h(CheckCircle, { size: 20 }), 'Pass'),
                  h('button', {
                    onClick: () => handleStatusUpdate('fail'),
                    className: 'flex-1 bg-red-500 text-white px-4 py-3 rounded font-semibold hover:bg-red-600 flex items-center justify-center gap-2'
                  }, h(XCircle, { size: 20 }), 'Fail'),
                  h('button', {
                    onClick: () => handleStatusUpdate('block'),
                    className: 'flex-1 bg-yellow-500 text-white px-4 py-3 rounded font-semibold hover:bg-yellow-600 flex items-center justify-center gap-2'
                  }, h(Clock, { size: 20 }), 'Block')
                )
              ),

              h('div', { className: 'flex items-center justify-between mt-6 pt-4 border-t' },
                h('button', {
                  onClick: () => setCurrentIndex(Math.max(0, currentIndex - 1)),
                  disabled: currentIndex === 0,
                  className: 'px-4 py-2 bg-gray-100 rounded hover:bg-gray-200 disabled:opacity-50'
                }, 'Previous'),
                h('span', { className: 'text-sm text-gray-600' },
                  `${currentIndex + 1} of ${testCases.length}`
                ),
                h('button', {
                  onClick: () => setCurrentIndex(Math.min(testCases.length - 1, currentIndex + 1)),
                  disabled: currentIndex === testCases.length - 1,
                  className: 'px-4 py-2 bg-gray-100 rounded hover:bg-gray-200 disabled:opacity-50'
                }, 'Next')
              )
            )
          );
        };

        const NewTestRunForm = ({ testCases, onSave, onCancel }) => {
          const [name, setName] = useState('');
          const [description, setDescription] = useState('');
          const [selectedTests, setSelectedTests] = useState(new Set());

          const handleSubmit = (e) => {
            e.preventDefault();
            if (name.trim() && selectedTests.size > 0) {
              onSave({
                name: name.trim(),
                description: description.trim(),
                testCaseIds: Array.from(selectedTests)
              });
            }
          };

          const toggleTest = (id) => {
            setSelectedTests(prev => {
              const next = new Set(prev);
              if (next.has(id)) {
                next.delete(id);
              } else {
                next.add(id);
              }
              return next;
            });
          };

          const selectAll = () => {
            setSelectedTests(new Set(testCases.map(tc => tc.id)));
          };

          const clearAll = () => {
            setSelectedTests(new Set());
          };

          return h('div', { className: 'modal-overlay', onClick: onCancel },
            h('div', {
              className: 'modal-content w-full max-w-3xl p-6',
              onClick: (e) => e.stopPropagation()
            },
              h('h2', { className: 'text-2xl font-bold mb-6' }, 'Create New Test Run'),
              h('form', { onSubmit: handleSubmit },
                h('div', { className: 'mb-4' },
                  h('label', { className: 'block text-sm font-medium mb-2' }, 'Run Name *'),
                  h('input', {
                    type: 'text',
                    value: name,
                    onChange: (e) => setName(e.target.value),
                    className: 'w-full border rounded p-2',
                    placeholder: 'e.g., Sprint 23 Regression',
                    required: true
                  })
                ),
                h('div', { className: 'mb-4' },
                  h('label', { className: 'block text-sm font-medium mb-2' }, 'Description'),
                  h('textarea', {
                    value: description,
                    onChange: (e) => setDescription(e.target.value),
                    className: 'w-full border rounded p-2 h-24',
                    placeholder: 'Describe the purpose of this test run...'
                  })
                ),
                h('div', { className: 'mb-4' },
                  h('div', { className: 'flex items-center justify-between mb-2' },
                    h('label', { className: 'text-sm font-medium' }, `Select Test Cases * (${selectedTests.size} selected)`),
                    h('div', { className: 'space-x-2' },
                      h('button', {
                        type: 'button',
                        onClick: selectAll,
                        className: 'text-sm text-blue-600 hover:underline'
                      }, 'Select All'),
                      h('button', {
                        type: 'button',
                        onClick: clearAll,
                        className: 'text-sm text-gray-600 hover:underline'
                      }, 'Clear All')
                    )
                  ),
                  h('div', { className: 'border rounded max-h-96 overflow-y-auto' },
                    testCases.length === 0 
                      ? h('div', { className: 'p-4 text-center text-gray-500' }, 'No test cases available')
                      : testCases.map(tc =>
                          h('label', {
                            key: tc.id,
                            className: 'flex items-start gap-3 p-3 hover:bg-gray-50 cursor-pointer border-b last:border-b-0'
                          },
                            h('input', {
                              type: 'checkbox',
                              checked: selectedTests.has(tc.id),
                              onChange: () => toggleTest(tc.id),
                              className: 'mt-1'
                            }),
                            h('div', { className: 'flex-1' },
                              h('div', { className: 'font-medium' }, tc.title),
                              h('div', { className: 'text-sm text-gray-600' }, tc.description)
                            )
                          )
                        )
                  )
                ),
                h('div', { className: 'flex gap-3 justify-end' },
                  h('button', {
                    type: 'button',
                    onClick: onCancel,
                    className: 'px-4 py-2 border rounded hover:bg-gray-50'
                  }, 'Cancel'),
                  h('button', {
                    type: 'submit',
                    disabled: !name.trim() || selectedTests.size === 0,
                    className: 'px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed'
                  }, 'Create Test Run')
                )
              )
            )
          );
        };

        // Main Application Component
        const RequirementsManager = () => {
          const [items, setItems] = useState([]);
          const [projects, setProjects] = useState([]);
          const [selectedProject, setSelectedProject] = useState(null);
          const [relationships, setRelationships] = useState([]);
          const [folders, setFolders] = useState([]);
          const [testRuns, setTestRuns] = useState([]);
          const [testResults, setTestResults] = useState([]);
          const [selectedItem, setSelectedItem] = useState(null);
          const [filterType, setFilterType] = useState('all');
          const [searchQuery, setSearchQuery] = useState('');
          const [showNewItemForm, setShowNewItemForm] = useState(false);
          const [showNewRunForm, setShowNewRunForm] = useState(false);
          const [activeTestRun, setActiveTestRun] = useState(null);
          const [view, setView] = useState('items'); // 'items', 'test-runs'
          const [sidebarOpen, setSidebarOpen] = useState(true);

          useEffect(() => {
            loadData();
          }, [selectedProject]);

          const loadData = async () => {
            try {
              const [itemsRes, relRes, projectsRes, foldersRes, testRunsRes, testResultsRes] = await Promise.all([
                dbOperation('items', 'readonly', store => store.getAll()),
                dbOperation('relationships', 'readonly', store => store.getAll()),
                dbOperation('projects', 'readonly', store => store.getAll()),
                dbOperation('folders', 'readonly', store => store.getAll()),
                dbOperation('testRuns', 'readonly', store => store.getAll()),
                dbOperation('testResults', 'readonly', store => store.getAll())
              ]);

              setItems(selectedProject 
                ? itemsRes.filter(item => item.projectId === selectedProject.id)
                : itemsRes
              );
              setRelationships(relRes);
              setProjects(projectsRes);
              setFolders(foldersRes);
              setTestRuns(testRunsRes);
              setTestResults(testResultsRes);

              if (projectsRes.length > 0 && !selectedProject) {
                setSelectedProject(projectsRes[0]);
              }
            } catch (error) {
              console.error('Error loading data:', error);
            }
          };

          const handleCreateTestRun = async (runData) => {
            const newRun = {
              id: `run-${Date.now()}`,
              ...runData,
              status: 'planned',
              createdAt: new Date().toISOString(),
              totalTests: runData.testCaseIds.length,
              passed: 0,
              failed: 0,
              blocked: 0
            };

            await dbOperation('testRuns', 'readwrite', store => store.add(newRun));
            setShowNewRunForm(false);
            loadData();
          };

          const handleUpdateTestResult = async (testCaseId, status, notes) => {
            if (!activeTestRun) return;

            const resultId = `result-${activeTestRun.id}-${testCaseId}`;
            const result = {
              id: resultId,
              runId: activeTestRun.id,
              testCaseId,
              status,
              notes,
              executedAt: new Date().toISOString()
            };

            await dbOperation('testResults', 'readwrite', store => store.put(result));

            // Update run statistics
            const allResults = await dbOperation('testResults', 'readonly', store => {
              const index = store.index('runId');
              return index.getAll(activeTestRun.id);
            });

            const stats = {
              passed: allResults.filter(r => r.status === 'pass').length,
              failed: allResults.filter(r => r.status === 'fail').length,
              blocked: allResults.filter(r => r.status === 'block').length
            };

            const completed = stats.passed + stats.failed + stats.blocked;
            const updatedRun = {
              ...activeTestRun,
              ...stats,
              status: completed === activeTestRun.totalTests ? 'completed' : 'in_progress',
              completedAt: completed === activeTestRun.totalTests ? new Date().toISOString() : activeTestRun.completedAt
            };

            await dbOperation('testRuns', 'readwrite', store => store.put(updatedRun));
            loadData();
          };

          const filteredItems = useMemo(() => {
            return items.filter(item => {
              const matchesType = filterType === 'all' || item.type === filterType;
              const matchesSearch = !searchQuery || 
                item.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                item.description?.toLowerCase().includes(searchQuery.toLowerCase());
              return matchesType && matchesSearch;
            });
          }, [items, filterType, searchQuery]);

          const testCases = items.filter(item => item.type === 'test_case');

          return h('div', { className: 'flex h-screen bg-gray-100' },
            // Sidebar
            sidebarOpen && h('div', { className: 'w-80 bg-white border-r flex flex-col' },
              h('div', { className: 'p-4 border-b' },
                h('div', { className: 'flex items-center justify-between mb-4' },
                  h('h1', { className: 'text-xl font-bold' }, 'Requirements'),
                  h('button', {
                    onClick: () => window.open('quick-start-guide.html', '_blank'),
                    className: 'p-2 hover:bg-gray-100 rounded',
                    title: 'Help & Quick Start Guide'
                  }, h(HelpCircle, { size: 20 }))
                ),
                h('div', { className: 'flex gap-2 mb-4' },
                  h('button', {
                    onClick: () => setView('items'),
                    className: `flex-1 px-3 py-2 rounded text-sm ${view === 'items' ? 'bg-blue-500 text-white' : 'bg-gray-100'}`
                  }, 'Items'),
                  h('button', {
                    onClick: () => setView('test-runs'),
                    className: `flex-1 px-3 py-2 rounded text-sm ${view === 'test-runs' ? 'bg-blue-500 text-white' : 'bg-gray-100'}`
                  }, 'Test Runs')
                ),
                h('div', { className: 'relative' },
                  h(Search, { size: 18, className: 'absolute left-3 top-2.5 text-gray-400' }),
                  h('input', {
                    type: 'text',
                    value: searchQuery,
                    onChange: (e) => setSearchQuery(e.target.value),
                    placeholder: 'Search...',
                    className: 'w-full pl-10 pr-3 py-2 border rounded'
                  })
                )
              ),
              
              view === 'items' && h('div', { className: 'p-4 border-b' },
                h('div', { className: 'flex gap-2' },
                  ['all', 'epic', 'requirement', 'test_case', 'defect'].map(type =>
                    h('button', {
                      key: type,
                      onClick: () => setFilterType(type),
                      className: `px-3 py-1 rounded text-sm ${filterType === type ? 'bg-blue-100 text-blue-700' : 'bg-gray-100'}`
                    }, type === 'all' ? 'All' : type.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '))
                  )
                )
              ),

              h('div', { className: 'flex-1 overflow-y-auto p-4' },
                view === 'items' 
                  ? h(FolderTree, {
                      folders,
                      items: filteredItems,
                      onSelectItem: setSelectedItem,
                      selectedItemId: selectedItem?.id
                    })
                  : h('div', { className: 'space-y-3' },
                      testRuns.length === 0 
                        ? h('div', { className: 'text-center py-8 text-gray-500' },
                            h(Play, { size: 48, className: 'mx-auto mb-2 opacity-50' }),
                            h('p', {}, 'No test runs yet'),
                            h('p', { className: 'text-sm' }, 'Create your first test run to start executing tests')
                          )
                        : testRuns.map(run =>
                            h(TestRunCard, {
                              key: run.id,
                              run,
                              onClick: () => setActiveTestRun(run)
                            })
                          )
                    )
              ),

              h('div', { className: 'p-4 border-t' },
                view === 'items' 
                  ? h('button', {
                      onClick: () => setShowNewItemForm(true),
                      className: 'w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex items-center justify-center gap-2'
                    }, h(Plus, { size: 18 }), 'New Item')
                  : h('button', {
                      onClick: () => setShowNewRunForm(true),
                      className: 'w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex items-center justify-center gap-2'
                    }, h(Play, { size: 18 }), 'New Test Run')
                )
            ),

            // Main content
            h('div', { className: 'flex-1 flex flex-col' },
              h('div', { className: 'bg-white border-b p-4 flex items-center justify-between' },
                h('button', {
                  onClick: () => setSidebarOpen(!sidebarOpen),
                  className: 'p-2 hover:bg-gray-100 rounded'
                }, h(Menu, { size: 20 })),
                h('div', { className: 'flex items-center gap-4' },
                  selectedProject && h('span', { className: 'text-sm text-gray-600' }, 
                    `Project: ${selectedProject.name}`
                  )
                )
              ),

              h('div', { className: 'flex-1 overflow-y-auto p-6' },
                selectedItem 
                  ? h('div', { className: 'bg-white rounded-lg shadow p-6 max-w-4xl mx-auto' },
                      h('h2', { className: 'text-2xl font-bold mb-4' }, selectedItem.title),
                      h('div', { className: 'prose max-w-none' },
                        h('p', {}, selectedItem.description),
                        selectedItem.type === 'test_case' && selectedItem.steps && h('div', { className: 'mt-4' },
                          h('h3', { className: 'font-semibold' }, 'Test Steps:'),
                          h('ol', { className: 'list-decimal list-inside' },
                            selectedItem.steps.split('\n').map((step, i) =>
                              h('li', { key: i }, step)
                            )
                          )
                        )
                      )
                    )
                  : view === 'test-runs' && !activeTestRun
                    ? h('div', { className: 'text-center py-16 text-gray-400' },
                        h(Play, { size: 64, className: 'mx-auto mb-4 opacity-50' }),
                        h('p', { className: 'text-xl' }, 'Select a test run to view details')
                      )
                    : h('div', { className: 'text-center py-16 text-gray-400' },
                        h(Filter, { size: 64, className: 'mx-auto mb-4 opacity-50' }),
                        h('p', { className: 'text-xl' }, 'Select an item to view details')
                      )
              )
            ),

            // Modals
            showNewRunForm && h(NewTestRunForm, {
              testCases,
              onSave: handleCreateTestRun,
              onCancel: () => setShowNewRunForm(false)
            }),

            activeTestRun && h(TestRunExecution, {
              run: activeTestRun,
              testCases: testCases.filter(tc => activeTestRun.testCaseIds.includes(tc.id)),
              results: testResults.filter(r => r.runId === activeTestRun.id),
              onUpdateResult: handleUpdateTestResult,
              onClose: () => setActiveTestRun(null)
            })
          );
        };

        // Initialize app
        const initApp = async () => {
          await initDB();
          const root = ReactDOM.createRoot(document.getElementById('root'));
          root.render(h(RequirementsManager));
        };

        initApp();
    </script>
</body>
</html>