<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fresh Consulting - Requirements Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Customize Tailwind with Fresh green colors
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fresh: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .folder-item { cursor: pointer; user-select: none; transition: background-color 0.15s; }
        .folder-item:hover { background-color: #f3f4f6; }
        .folder-expanded { font-weight: 600; }
        .folder-children { padding-left: 16px; margin-left: 8px; border-left: 2px solid #e5e7eb; }
        .test-run-card { transition: all 0.2s ease; }
        .test-run-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <!-- Load React and ReactDOM first -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Then load our app as a module after React is ready -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm';
        
        // Wait for React to be loaded before initializing
        async function initApp() {
            // Wait for React to be available on window
            while (typeof window.React === 'undefined' || typeof window.ReactDOM === 'undefined') {
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            const { useState, useEffect, useMemo, useRef, createElement: h } = window.React;

        // ============================================
        // DEVELOPMENT CREDENTIALS (Set these to skip config screen)
        // ============================================
        const DEV_SUPABASE_URL = 'https://ttkcqwsfdmlzxrndjrov.supabase.co';
        const DEV_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0a2Nxd3NmZG1senhybmRqcm92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MDczMTksImV4cCI6MjA3NjI4MzMxOX0.aQEDyTLZQC8t0Z1pOWG_zNMGpDTKWu_YYmLmZq2HgXc';
        // ============================================

        // Icon components
        const Icon = ({ d, size = 24, ...props }) => h('svg', {
            width: size,
            height: size,
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2',
            strokeLinecap: 'round',
            strokeLinejoin: 'round',
            ...props
        }, typeof d === 'string' ? h('path', { d }) : d);

        const Plus = ({ size }) => Icon({ size, d: 'M12 5v14M5 12h14' });
        const Link2 = ({ size }) => Icon({ size, d: ['M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71', 'M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'].map((d, i) => h('path', { key: i, d })) });
        const GitBranch = ({ size }) => Icon({ size, d: ['M6 3v12', h('circle', { key: 'c1', cx: 18, cy: 6, r: 3 }), h('circle', { key: 'c2', cx: 6, cy: 18, r: 3 }), h('path', { key: 'p', d: 'M18 9a9 9 0 0 1-9 9' })] });
        const MessageSquare = ({ size }) => Icon({ size, d: 'M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z' });
        const Edit2 = ({ size }) => Icon({ size, d: 'M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z' });
        const Trash2 = ({ size }) => Icon({ size, d: ['M3 6h18', 'M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2', 'M10 11v6', 'M14 11v6'].map((d, i) => h(d.includes('M') ? 'path' : 'line', { key: i, [d.includes('M') ? 'd' : 'x1']: d.includes('M') ? d : d.split(' ')[0], ...(d.includes(' ') && !d.includes('M') ? { y1: d.split(' ')[1], x2: d.split(' ')[2], y2: d.split(' ')[3] } : {}) })) });
        const Save = ({ size }) => Icon({ size, d: ['M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z', 'M17 21v-8H7v8', 'M7 3v5h8'].map((d, i) => h(d.includes('M') ? 'path' : 'polyline', { key: i, [d.includes('M') ? 'd' : 'points']: d })) });
        const X = ({ size }) => Icon({ size, d: h('g', {}, [h('line', { key: 1, x1: 18, y1: 6, x2: 6, y2: 18 }), h('line', { key: 2, x1: 6, y1: 6, x2: 18, y2: 18 })]) });
        const ChevronRight = ({ size }) => Icon({ size, d: h('polyline', { points: '9 18 15 12 9 6' }) });
        const ChevronDown = ({ size }) => Icon({ size, d: h('polyline', { points: '6 9 12 15 18 9' }) });
        const Filter = ({ size }) => Icon({ size, d: h('polygon', { points: '22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3' }) });
        const Search = ({ size }) => Icon({ size, d: [h('circle', { key: 'c', cx: 11, cy: 11, r: 8 }), h('path', { key: 'p', d: 'm21 21-4.35-4.35' })] });
        const BarChart3 = ({ size }) => Icon({ size, d: ['M3 3v18h18', 'M18 17V9', 'M13 17V5', 'M8 17v-3'].map((d, i) => h('path', { key: i, d })) });
        const PieChart = ({ size }) => Icon({ size, d: ['M21.21 15.89A10 10 0 1 1 8 2.83', 'M22 12A10 10 0 0 0 12 2v10z'].map((d, i) => h('path', { key: i, d })) });
        const TrendingUp = ({ size }) => Icon({ size, d: [h('polyline', { key: 1, points: '23 6 13.5 15.5 8.5 10.5 1 18' }), h('polyline', { key: 2, points: '17 6 23 6 23 12' })] });
        const CheckCircle = ({ size }) => Icon({ size, d: [h('path', { key: 1, d: 'M22 11.08V12a10 10 0 1 1-5.93-9.14' }), h('polyline', { key: 2, points: '22 4 12 14.01 9 11.01' })] });
        const XCircle = ({ size }) => Icon({ size, d: [h('circle', { key: 1, cx: 12, cy: 12, r: 10 }), h('line', { key: 2, x1: 15, y1: 9, x2: 9, y2: 15 }), h('line', { key: 3, x1: 9, y1: 9, x2: 15, y2: 15 })] });
        const GripVertical = ({ size }) => Icon({ size, d: [h('circle', { key: 1, cx: 9, cy: 12, r: 1 }), h('circle', { key: 2, cx: 9, cy: 5, r: 1 }), h('circle', { key: 3, cx: 9, cy: 19, r: 1 }), h('circle', { key: 4, cx: 15, cy: 12, r: 1 }), h('circle', { key: 5, cx: 15, cy: 5, r: 1 }), h('circle', { key: 6, cx: 15, cy: 19, r: 1 })] });
        // NEW ICONS for folders and test runs
        const Folder = ({ size }) => Icon({ size, d: 'M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z' });
        const FolderOpen = ({ size }) => Icon({ size, d: [h('path', { key: 1, d: 'M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z' }), h('path', { key: 2, d: 'M2 8v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2H8' })] });
        const Play = ({ size }) => Icon({ size, d: 'M5 3l14 9-14 9V3z' });
        const HelpCircle = ({ size }) => Icon({ size, d: [h('circle', { key: 1, cx: 12, cy: 12, r: 10 }), h('path', { key: 2, d: 'M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3' }), h('line', { key: 3, x1: 12, y1: 17, x2: 12.01, y2: 17 })] });
        const Clock = ({ size }) => Icon({ size, d: [h('circle', { key: 1, cx: 12, cy: 12, r: 10 }), h('polyline', { key: 2, points: '12 6 12 12 16 14' })] });
        const List = ({ size }) => Icon({ size, d: [h('line', { key: 1, x1: 8, y1: 6, x2: 21, y2: 6 }), h('line', { key: 2, x1: 8, y1: 12, x2: 21, y2: 12 }), h('line', { key: 3, x1: 8, y1: 18, x2: 21, y2: 18 }), h('line', { key: 4, x1: 3, y1: 6, x2: 3.01, y2: 6 }), h('line', { key: 5, x1: 3, y1: 12, x2: 3.01, y2: 12 }), h('line', { key: 6, x1: 3, y1: 18, x2: 3.01, y2: 18 })] });

        const RequirementsManager = () => {
          const [supabaseUrl, setSupabaseUrl] = useState(DEV_SUPABASE_URL || '');
          const [supabaseKey, setSupabaseKey] = useState(DEV_SUPABASE_KEY || '');
          const [supabase, setSupabase] = useState(null);
          const [isConfigured, setIsConfigured] = useState(false);
          const [user, setUser] = useState(null);
          const [showAuthPrompt, setShowAuthPrompt] = useState(false);
          
          const [items, setItems] = useState([]);
          const [relationships, setRelationships] = useState([]);
          const [comments, setComments] = useState([]);
          const [auditLogs, setAuditLogs] = useState([]);
          const [projects, setProjects] = useState([]);
          const [selectedProject, setSelectedProject] = useState(null);
          const [showProjectForm, setShowProjectForm] = useState(false);
          const [projectSearchTerm, setProjectSearchTerm] = useState('');
          const [showProjectDropdown, setShowProjectDropdown] = useState(false);
          const [selectedItem, setSelectedItem] = useState(null);
          const [editingItem, setEditingItem] = useState(null);
          const [showNewItemForm, setShowNewItemForm] = useState(false);
          const [newComment, setNewComment] = useState('');
          const [expandedItems, setExpandedItems] = useState(new Set([1]));
          const [filterType, setFilterType] = useState('all');
          const [filterStatus, setFilterStatus] = useState('all');
          const [searchTerm, setSearchTerm] = useState('');
          const [showRelationshipForm, setShowRelationshipForm] = useState(false);
          const [showReports, setShowReports] = useState(false);
          const [loading, setLoading] = useState(false);
          const [showGraphView, setShowGraphView] = useState(false);
          const [showApprovalModal, setShowApprovalModal] = useState(false);
          const [showAuditHistory, setShowAuditHistory] = useState(false);
          const [showDetailPanel, setShowDetailPanel] = useState(true);
          const [showReviewPanel, setShowReviewPanel] = useState(true);
          const [showTestPanel, setShowTestPanel] = useState(true);
          const [draggedItem, setDraggedItem] = useState(null);
          const [dropTarget, setDropTarget] = useState(null);
          const [approvalAction, setApprovalAction] = useState('approve');
          const [approvalNotes, setApprovalNotes] = useState('');
          const [showImportModal, setShowImportModal] = useState(false);
          const [importFile, setImportFile] = useState(null);
          
          // NEW STATE for folders and test runs
          const [folders, setFolders] = useState([]);
          const [expandedFolders, setExpandedFolders] = useState(new Set());
          const [testRuns, setTestRuns] = useState([]);
          const [testResults, setTestResults] = useState([]);
          const [showNewRunForm, setShowNewRunForm] = useState(false);
          const [activeTestRun, setActiveTestRun] = useState(null);
          const [viewMode, setViewMode] = useState('tree'); // 'tree' or 'test-runs'
          
          const itemTypes = ['epic', 'requirement', 'test-case', 'defect'];
          const statuses = {
            epic: ['draft', 'in-review', 'approved', 'rejected'],
            requirement: ['draft', 'in-review', 'approved', 'rejected'],
            'test-case': ['draft', 'ready-for-test', 'passed', 'failed'],
            defect: ['not-started', 'in-process', 'resolved', 'backlog']
          };
          const priorities = ['low', 'medium', 'high', 'critical'];
          const relationshipTypes = ['tests', 'depends-on', 'derives-from', 'relates-to'];
          
          const requirementLevels = [
            'system',
            'sub-system', 
            'assembly',
            'sub-assembly',
            'component',
            'sub-component',
            'material'
          ];

          useEffect(() => {
            if (DEV_SUPABASE_URL && DEV_SUPABASE_KEY && !supabase) {
              initializeSupabase();
            }
          }, []);

          const initializeSupabase = () => {
            if (supabaseUrl && supabaseKey) {
              const client = createClient(supabaseUrl, supabaseKey);
              setSupabase(client);
              setIsConfigured(true);
              
              client.auth.onAuthStateChange((event, session) => {
                setUser(session?.user || null);
                if (session?.user) {
                  loadData(client);
                }
              });
              
              client.auth.getSession().then(({ data: { session } }) => {
                setUser(session?.user || null);
                if (session?.user) {
                  loadData(client);
                } else {
                  setShowAuthPrompt(true);
                }
              });
            }
          };

          const handleGoogleSignIn = async () => {
            if (!supabase) return;
            
            try {
              const currentUrl = window.location.origin + window.location.pathname;
              
              const { error } = await supabase.auth.signInWithOAuth({
                provider: 'google',
                options: {
                  redirectTo: currentUrl
                }
              });
              
              if (error) throw error;
            } catch (error) {
              console.error('Error signing in:', error);
              alert('Error signing in with Google: ' + error.message);
            }
          };

          const handleSignOut = async () => {
            if (!supabase) return;
            await supabase.auth.signOut();
            setUser(null);
            setShowAuthPrompt(true);
            setSelectedItem(null);
            setEditingItem(null);
            setSelectedProject(null);
            setItems([]);
            setRelationships([]);
            setComments([]);
            setAuditLogs([]);
            setProjects([]);
            setFolders([]);
            setTestRuns([]);
            setTestResults([]);
          };

          const loadData = async (client) => {
            setLoading(true);
            try {
              const [itemsRes, relationshipsRes, commentsRes, projectsRes, auditLogsRes, foldersRes, testRunsRes, testResultsRes] = await Promise.all([
                client.from('items').select('*').order('id'),
                client.from('relationships').select('*'),
                client.from('comments').select('*').order('timestamp', { ascending: false }),
                client.from('projects').select('*').order('name'),
                client.from('audit_logs').select('*').order('timestamp', { ascending: false }),
                // NEW: Load folders
                client.from('folders').select('*').order('name').then(res => res || { data: [], error: null }),
                // NEW: Load test runs
                client.from('test_runs').select('*').order('created_at', { ascending: false }).then(res => res || { data: [], error: null }),
                // NEW: Load test results
                client.from('test_results').select('*').then(res => res || { data: [], error: null })
              ]);
              
              if (itemsRes.data) setItems(itemsRes.data);
              if (relationshipsRes.data) setRelationships(relationshipsRes.data);
              if (commentsRes.data) setComments(commentsRes.data);
              if (auditLogsRes.data) setAuditLogs(auditLogsRes.data);
              if (projectsRes.data) {
                setProjects(projectsRes.data);
              }
              // NEW: Set folders and test data
              if (foldersRes.data) setFolders(foldersRes.data);
              if (testRunsRes.data) setTestRuns(testRunsRes.data);
              if (testResultsRes.data) setTestResults(testResultsRes.data);
            } catch (error) {
              console.error('Error loading data:', error);
              alert('Error loading data. Please check your Supabase credentials and table setup.');
            }
            setLoading(false);
          };

          const createAuditLog = async (itemId, action, fieldName, oldValue, newValue) => {
            if (!supabase || !user) return;
            
            try {
              const logEntry = {
                item_id: itemId,
                user_email: user.email,
                user_name: user.user_metadata?.full_name || user.email,
                action: action,
                field_name: fieldName,
                old_value: oldValue ? String(oldValue) : null,
                new_value: newValue ? String(newValue) : null,
                timestamp: new Date().toISOString()
              };
              
              const { data, error } = await supabase.from('audit_logs').insert([logEntry]).select();
              
              if (error) throw error;
              
              if (data && data[0]) {
                setAuditLogs([data[0], ...auditLogs]);
              }
            } catch (error) {
              console.error('Error creating audit log:', error);
            }
          };

          const setupDatabase = async () => {
            alert(`Please run these SQL commands in your Supabase SQL editor:

CREATE TABLE projects (
  id BIGSERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  pid TEXT NOT NULL UNIQUE,
  project_manager TEXT,
  lead_engineer TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE items (
  id BIGSERIAL PRIMARY KEY,
  project_id BIGINT REFERENCES projects(id) ON DELETE CASCADE,
  folder_id BIGINT,
  type TEXT NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  rationale TEXT,
  test_method TEXT,
  status TEXT NOT NULL,
  priority TEXT,
  owner TEXT,
  version INTEGER DEFAULT 1,
  parent_id BIGINT REFERENCES items(id) ON DELETE CASCADE,
  children INTEGER[] DEFAULT '{}',
  reviewer_email TEXT,
  tester_email TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE relationships (
  id BIGSERIAL PRIMARY KEY,
  from_id BIGINT REFERENCES items(id) ON DELETE CASCADE,
  to_id BIGINT REFERENCES items(id) ON DELETE CASCADE,
  type TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE comments (
  id BIGSERIAL PRIMARY KEY,
  item_id BIGINT REFERENCES items(id) ON DELETE CASCADE,
  author TEXT NOT NULL,
  author_email TEXT,
  text TEXT NOT NULL,
  timestamp TIMESTAMP DEFAULT NOW()
);

CREATE TABLE audit_logs (
  id BIGSERIAL PRIMARY KEY,
  item_id BIGINT REFERENCES items(id) ON DELETE CASCADE,
  user_email TEXT NOT NULL,
  user_name TEXT,
  action TEXT NOT NULL,
  field_name TEXT,
  old_value TEXT,
  new_value TEXT,
  timestamp TIMESTAMP DEFAULT NOW()
);

CREATE TABLE folders (
  id BIGSERIAL PRIMARY KEY,
  project_id BIGINT REFERENCES projects(id) ON DELETE CASCADE,
  parent_id BIGINT REFERENCES folders(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE test_runs (
  id BIGSERIAL PRIMARY KEY,
  project_id BIGINT REFERENCES projects(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  status TEXT DEFAULT 'planned',
  created_by TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  completed_at TIMESTAMP
);

CREATE TABLE test_results (
  id BIGSERIAL PRIMARY KEY,
  test_run_id BIGINT REFERENCES test_runs(id) ON DELETE CASCADE,
  test_case_id BIGINT REFERENCES items(id) ON DELETE CASCADE,
  status TEXT NOT NULL,
  notes TEXT,
  executed_by TEXT,
  executed_at TIMESTAMP DEFAULT NOW()
);

ALTER TABLE projects ENABLE ROW LEVEL SECURITY;
ALTER TABLE items ENABLE ROW LEVEL SECURITY;
ALTER TABLE relationships ENABLE ROW LEVEL SECURITY;
ALTER TABLE comments ENABLE ROW LEVEL SECURITY;
ALTER TABLE audit_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE folders ENABLE ROW LEVEL SECURITY;
ALTER TABLE test_runs ENABLE ROW LEVEL SECURITY;
ALTER TABLE test_results ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Enable all operations" ON projects FOR ALL USING (true);
CREATE POLICY "Enable all operations" ON items FOR ALL USING (true);
CREATE POLICY "Enable all operations" ON relationships FOR ALL USING (true);
CREATE POLICY "Enable all operations" ON comments FOR ALL USING (true);
CREATE POLICY "Enable all operations" ON audit_logs FOR ALL USING (true);
CREATE POLICY "Enable all operations" ON folders FOR ALL USING (true);
CREATE POLICY "Enable all operations" ON test_runs FOR ALL USING (true);
CREATE POLICY "Enable all operations" ON test_results FOR ALL USING (true);

CREATE TABLE IF NOT EXISTS folders (
  id BIGSERIAL PRIMARY KEY,
  project_id BIGINT REFERENCES projects(id) ON DELETE CASCADE,
  parent_id BIGINT REFERENCES folders(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS test_runs (
  id BIGSERIAL PRIMARY KEY,
  project_id BIGINT REFERENCES projects(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  status TEXT DEFAULT 'planned',
  created_by TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  completed_at TIMESTAMP
);

CREATE TABLE IF NOT EXISTS test_results (
  id BIGSERIAL PRIMARY KEY,
  test_run_id BIGINT REFERENCES test_runs(id) ON DELETE CASCADE,
  test_case_id BIGINT REFERENCES items(id) ON DELETE CASCADE,
  status TEXT NOT NULL DEFAULT 'pending',
  notes TEXT,
  executed_by TEXT,
  executed_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(test_run_id, test_case_id)
);

ALTER TABLE items ADD COLUMN IF NOT EXISTS folder_id BIGINT REFERENCES folders(id) ON DELETE SET NULL;

ALTER TABLE folders ENABLE ROW LEVEL SECURITY;
ALTER TABLE test_runs ENABLE ROW LEVEL SECURITY;
ALTER TABLE test_results ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Enable all operations" ON folders FOR ALL USING (true);
CREATE POLICY "Enable all operations" ON test_runs FOR ALL USING (true);
CREATE POLICY "Enable all operations" ON test_results FOR ALL USING (true);`);
          };

          const toggleExpand = (id) => {
            setExpandedItems(prev => {
              const next = new Set(prev);
              if (next.has(id)) next.delete(id);
              else next.add(id);
              return next;
            });
          };

          const toggleFolder = (id) => {
            setExpandedFolders(prev => {
              const next = new Set(prev);
              if (next.has(id)) next.delete(id);
              else next.add(id);
              return next;
            });
          };

          const collapseAll = () => {
            setExpandedItems(new Set());
          };

          const expandToLevel = (targetLevel) => {
            const newExpandedItems = new Set();
            
            const shouldExpand = (item) => {
              if (item.type !== 'requirement') {
                return item.children && item.children.length > 0;
              }
              
              const itemLevel = requirementLevels.indexOf(item.level || 'system');
              const targetLevelIndex = requirementLevels.indexOf(targetLevel);
              
              return itemLevel <= targetLevelIndex && item.children && item.children.length > 0;
            };
            
            const processItem = (item) => {
              if (shouldExpand(item)) {
                newExpandedItems.add(item.id);
                if (item.children) {
                  item.children.forEach(childId => {
                    const childItem = items.find(i => i.id === childId);
                    if (childItem) processItem(childItem);
                  });
                }
              }
            };
            
            items.filter(item => !item.parent_id).forEach(processItem);
            
            setExpandedItems(newExpandedItems);
          };

          const refreshSelectedItem = async () => {
            if (!selectedItem || !supabase) return;
            
            try {
              const { data, error } = await supabase
                .from('items')
                .select('*')
                .eq('id', selectedItem.id)
                .single();
              
              if (error) throw error;
              
              if (data) {
                setSelectedItem(data);
                setItems(prev => prev.map(i => i.id === data.id ? data : i));
                setEditingItem(null);
              }
            } catch (error) {
              console.error('Error refreshing item:', error);
            }
          };

          const handleUpdateParent = async (itemId, newParentId) => {
            if (!supabase) return;
            
            try {
              const { data: currentItem } = await supabase
                .from('items')
                .select('*')
                .eq('id', itemId)
                .single();
              
              if (!currentItem) return;
              
              if (currentItem.parent_id) {
                const { data: oldParent } = await supabase
                  .from('items')
                  .select('*')
                  .eq('id', currentItem.parent_id)
                  .single();
                
                if (oldParent) {
                  const updatedChildren = (oldParent.children || []).filter(id => id !== itemId);
                  await supabase
                    .from('items')
                    .update({ children: updatedChildren })
                    .eq('id', currentItem.parent_id);
                }
              }
              
              await supabase
                .from('items')
                .update({ parent_id: newParentId })
                .eq('id', itemId);
              
              if (newParentId) {
                const { data: newParent } = await supabase
                  .from('items')
                  .select('*')
                  .eq('id', newParentId)
                  .single();
                
                if (newParent) {
                  const updatedChildren = [...(newParent.children || []), itemId];
                  await supabase
                    .from('items')
                    .update({ children: updatedChildren })
                    .eq('id', newParentId);
                }
              }
              
              await loadData(supabase);
              
              console.log('Parent updated successfully');
            } catch (error) {
              console.error('Error updating parent:', error);
              alert('Error updating parent. Please refresh the page.');
            }
          };

          const handleCreateItem = async (formData) => {
            if (!supabase) return;
            
            try {
              const newItem = {
                project_id: selectedProject.id,
                type: formData.type,
                title: formData.title,
                description: formData.description,
                rationale: formData.rationale || null,
                test_method: formData.test_method || null,
                status: formData.status,
                priority: formData.priority || null,
                owner: formData.owner || null,
                reviewer_email: formData.reviewer_email || null,
                tester_email: formData.tester_email || null,
                parent_id: formData.parentId,
                folder_id: formData.folderId || null,
                children: [],
                version: 1,
                level: formData.level || 'system'
              };

              const { data, error } = await supabase.from('items').insert([newItem]).select();
              
              if (error) throw error;
              
              if (data && data[0]) {
                setItems([...items, data[0]]);
                
                if ((formData.references || formData.relationships) && (formData.references?.length > 0 || formData.relationships?.length > 0)) {
                  const relationshipsToCreate = formData.references || formData.relationships || [];
                  for (const rel of relationshipsToCreate) {
                    const relData = typeof rel === 'number' 
                      ? { from_id: data[0].id, to_id: rel, type: 'tests' }
                      : { from_id: data[0].id, to_id: rel.to, type: rel.type };
                    await supabase.from('relationships').insert([relData]);
                  }
                  const { data: newRels } = await supabase.from('relationships').select('*');
                  if (newRels) setRelationships(newRels);
                }
                
                await createAuditLog(data[0].id, 'create', null, null, `Created ${data[0].type}: ${data[0].title}`);
                
                if (formData.parentId) {
                  const parent = items.find(i => i.id === formData.parentId);
                  if (parent) {
                    const updatedChildren = [...(parent.children || []), data[0].id];
                    await supabase.from('items').update({ children: updatedChildren }).eq('id', formData.parentId);
                    setItems(prev => prev.map(item => 
                      item.id === formData.parentId 
                        ? { ...item, children: updatedChildren }
                        : item
                    ));
                  }
                }
              }
              
              setShowNewItemForm(false);
              setSelectedItem(data[0]);
            } catch (error) {
              console.error('Error creating item:', error);
              alert('Error creating item: ' + error.message);
            }
          };

          const handleUpdateItem = async (id, updates) => {
            if (!supabase || !user) return;
            
            try {
              const item = items.find(i => i.id === id);
              
              if (item.status === 'approved' && updates && Object.keys(updates).length > 0) {
                const hasRealChanges = Object.keys(updates).some(key => {
                  if (key === 'reviewer_email' || key === 'tester_email') return false;
                  return updates[key] !== item[key];
                });
                
                if (hasRealChanges) {
                  updates = { ...updates, status: 'draft' };
                }
              }
              
              for (const [key, newValue] of Object.entries(updates)) {
                const oldValue = item[key];
                if (oldValue !== newValue) {
                  await createAuditLog(id, 'update', key, oldValue, newValue);
                }
              }
              
              const { error } = await supabase
                .from('items')
                .update({ 
                  ...updates, 
                  version: item.version + 1,
                  updated_at: new Date().toISOString()
                })
                .eq('id', id);
              
              if (error) throw error;
              
              setItems(prev => prev.map(item => 
                item.id === id 
                  ? { ...item, ...updates, version: item.version + 1 }
                  : item
              ));
              setEditingItem(null);
              
              await refreshSelectedItem();
            } catch (error) {
              console.error('Error updating item:', error);
              alert('Error updating item: ' + error.message);
            }
          };

          const handleApproveItem = async (itemId, action, notes) => {
            if (!supabase || !user) return;
            
            const item = items.find(i => i.id === itemId);
            if (!item) return;
            
            const isAuthorized = (item.type === 'test-case' && item.tester_email === user.email) ||
                                 (item.type !== 'test-case' && item.reviewer_email === user.email);
            
            if (!isAuthorized) {
              const role = item.type === 'test-case' ? 'tester' : 'reviewer';
              alert(`Only the assigned ${role} can perform this action.`);
              return;
            }
            
            try {
              let newStatus;
              if (action === 'approve') {
                newStatus = 'approved';
              } else if (action === 'reject') {
                newStatus = 'draft';
              } else if (action === 'pass') {
                newStatus = 'passed';
              } else if (action === 'fail') {
                newStatus = 'failed';
              }
              
              await createAuditLog(itemId, action, 'status', item.status, newStatus);
              if (notes) {
                const noteType = item.type === 'test-case' ? 'test_notes' : 'review_notes';
                await createAuditLog(itemId, noteType, null, null, notes);
              }
              
              const { error } = await supabase
                .from('items')
                .update({ 
                  status: newStatus,
                  updated_at: new Date().toISOString()
                })
                .eq('id', itemId);
              
              if (error) throw error;
              
              setItems(prev => prev.map(i => 
                i.id === itemId 
                  ? { ...i, status: newStatus }
                  : i
              ));
              
              await refreshSelectedItem();
              
              setShowApprovalModal(false);
              setApprovalNotes('');
            } catch (error) {
              console.error('Error processing action:', error);
              alert('Error processing action: ' + error.message);
            }
          };

          const handleDeleteItem = async (id) => {
            if (!supabase) return;
            
            try {
              const item = items.find(i => i.id === id);
              
              if (item.parent_id) {
                const parent = items.find(i => i.id === item.parent_id);
                if (parent) {
                  const updatedChildren = parent.children.filter(c => c !== id);
                  await supabase.from('items').update({ children: updatedChildren }).eq('id', item.parent_id);
                }
              }
              
              const { error } = await supabase.from('items').delete().eq('id', id);
              
              if (error) throw error;
              
              setItems(prev => prev.filter(i => i.id !== id));
              setRelationships(prev => prev.filter(r => r.from_id !== id && r.to_id !== id));
              setSelectedItem(null);
            } catch (error) {
              console.error('Error deleting item:', error);
              alert('Error deleting item: ' + error.message);
            }
          };

          const handleCreateProject = async (projectData) => {
            if (!supabase || !user) return;
            
            try {
              const { data, error } = await supabase.from('projects').insert([projectData]).select();
              
              if (error) throw error;
              
              if (data && data[0]) {
                setProjects([...projects, data[0]]);
                setSelectedProject(data[0]);
              }
              
              setShowProjectForm(false);
            } catch (error) {
              console.error('Error creating project:', error);
              alert('Error creating project: ' + error.message);
            }
          };

          const handleAddComment = async (itemId) => {
            if (!supabase || !newComment.trim() || !user) return;
            
            try {
              const comment = {
                item_id: itemId,
                author: user.user_metadata?.full_name || user.email,
                author_email: user.email,
                text: newComment,
                timestamp: new Date().toISOString()
              };
              
              const { data, error } = await supabase.from('comments').insert([comment]).select();
              
              if (error) throw error;
              
              if (data && data[0]) {
                setComments([data[0], ...comments]);
              }
              setNewComment('');
              
              await createAuditLog(itemId, 'comment', null, null, newComment);
            } catch (error) {
              console.error('Error adding comment:', error);
              alert('Error adding comment: ' + error.message);
            }
          };

          const handleAddRelationship = async (from, to, type) => {
            if (!supabase) return;
            
            try {
              const relationship = {
                from_id: from,
                to_id: to,
                type: type
              };
              
              const { data, error } = await supabase.from('relationships').insert([relationship]).select();
              
              if (error) throw error;
              
              if (data && data[0]) {
                setRelationships([...relationships, data[0]]);
              }
              setShowRelationshipForm(false);
            } catch (error) {
              console.error('Error adding relationship:', error);
              alert('Error adding relationship: ' + error.message);
            }
          };

          const handleDeleteRelationship = async (relationshipId) => {
            if (!supabase) return;
            
            try {
              const { error } = await supabase.from('relationships').delete().eq('id', relationshipId);
              
              if (error) throw error;
              
              setRelationships(prev => prev.filter(r => r.id !== relationshipId));
            } catch (error) {
              console.error('Error deleting relationship:', error);
              alert('Error deleting relationship: ' + error.message);
            }
          };

          // NEW: Test Run Handlers
          const handleCreateTestRun = async (runData) => {
            if (!supabase || !user || !selectedProject) return;
            
            try {
              const newRun = {
                project_id: selectedProject.id,
                name: runData.name,
                description: runData.description,
                status: 'planned',
                created_by: user.email,
                created_at: new Date().toISOString()
              };
              
              const { data, error } = await supabase.from('test_runs').insert([newRun]).select();
              
              if (error) throw error;
              
              if (data && data[0]) {
                // Create test result placeholders
                const results = runData.testCaseIds.map(tcId => ({
                  test_run_id: data[0].id,
                  test_case_id: tcId,
                  status: 'pending'
                }));
                
                await supabase.from('test_results').insert(results);
                
                setTestRuns([data[0], ...testRuns]);
                setShowNewRunForm(false);
                loadData(supabase);
              }
            } catch (error) {
              console.error('Error creating test run:', error);
              alert('Error creating test run: ' + error.message);
            }
          };

          const handleUpdateTestResult = async (runId, testCaseId, status, notes) => {
            if (!supabase || !user) return;
            
            try {
              const result = {
                test_run_id: runId,
                test_case_id: testCaseId,
                status: status,
                notes: notes,
                executed_by: user.email,
                executed_at: new Date().toISOString()
              };
              
              const { data, error } = await supabase
                .from('test_results')
                .upsert(result, { onConflict: 'test_run_id,test_case_id' })
                .select();
              
              if (error) throw error;
              
              // Update run status
              const runResults = testResults.filter(r => r.test_run_id === runId);
              const allCompleted = runResults.every(r => r.status !== 'pending');
              
              if (allCompleted) {
                await supabase
                  .from('test_runs')
                  .update({ 
                    status: 'completed',
                    completed_at: new Date().toISOString()
                  })
                  .eq('id', runId);
              } else {
                await supabase
                  .from('test_runs')
                  .update({ status: 'in_progress' })
                  .eq('id', runId);
              }
              
              loadData(supabase);
            } catch (error) {
              console.error('Error updating test result:', error);
              alert('Error updating test result: ' + error.message);
            }
          };

          const downloadCSVTemplate = () => {
            const headers = ['type', 'title', 'description', 'rationale', 'test_method', 'status', 'priority', 'owner', 'level', 'reviewer_email', 'tester_email'];
            const exampleRows = [
              ['requirement', 'System shall support user authentication', 'The system must authenticate users via username and password', 'Security requirement to protect user data', '', 'draft', 'high', 'john@example.com', 'system', 'jane@example.com', ''],
              ['requirement', 'Login page shall timeout after 15 minutes', 'For security, idle sessions must timeout', 'Prevents unauthorized access to unattended sessions', '', 'draft', 'medium', 'john@example.com', 'sub-system', 'jane@example.com', ''],
              ['test-case', 'Verify login with valid credentials', 'Test that user can log in with correct username and password', '', 'Manual test: Enter valid credentials and verify successful login', 'draft', 'high', 'sarah@example.com', '', '', 'sarah@example.com'],
              ['epic', 'User Authentication Feature', 'Epic to group all authentication-related requirements', '', '', 'draft', 'high', 'john@example.com', '', '', '']
            ];
            
            const csvContent = [
              headers.join(','),
              ...exampleRows.map(row => row.map(cell => {
                if (cell.includes(',') || cell.includes('"') || cell.includes('\n')) {
                  return '"' + cell.replace(/"/g, '""') + '"';
                }
                return cell;
              }).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'requirements_import_template.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          };

          const handleImportCSV = async (file) => {
            if (!file || !supabase || !selectedProject) return;
            
            try {
              const text = await file.text();
              const lines = text.split('\n').filter(line => line.trim());
              
              if (lines.length < 2) {
                alert('CSV file is empty or invalid');
                return;
              }
              
              const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
              
              const rows = [];
              for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let j = 0; j < line.length; j++) {
                  const char = line[j];
                  
                  if (char === '"') {
                    if (inQuotes && line[j + 1] === '"') {
                      current += '"';
                      j++;
                    } else {
                      inQuotes = !inQuotes;
                    }
                  } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                  } else {
                    current += char;
                  }
                }
                values.push(current.trim());
                
                if (values.length === headers.length) {
                  const row = {};
                  headers.forEach((header, idx) => {
                    row[header] = values[idx];
                  });
                  rows.push(row);
                }
              }
              
              if (rows.length === 0) {
                alert('No valid data rows found in CSV');
                return;
              }
              
              let successCount = 0;
              let errorCount = 0;
              const errors = [];
              
              for (const row of rows) {
                try {
                  if (!row.type || !row.title) {
                    errors.push(`Row skipped: Missing type or title - "${row.title || 'untitled'}"`);
                    errorCount++;
                    continue;
                  }
                  
                  if (!itemTypes.includes(row.type)) {
                    errors.push(`Row skipped: Invalid type "${row.type}" for "${row.title}"`);
                    errorCount++;
                    continue;
                  }
                  
                  const newItem = {
                    project_id: selectedProject.id,
                    type: row.type,
                    title: row.title,
                    description: row.description || '',
                    status: row.status || 'draft',
                    version: 1
                  };
                  
                  if (row.priority) newItem.priority = row.priority;
                  if (row.owner) newItem.owner = row.owner;
                  if (row.rationale && row.type === 'requirement') newItem.rationale = row.rationale;
                  if (row.test_method && row.type === 'test-case') newItem.test_method = row.test_method;
                  if (row.level && row.type === 'requirement') newItem.level = row.level;
                  if (row.reviewer_email && (row.type === 'requirement' || row.type === 'epic')) {
                    newItem.reviewer_email = row.reviewer_email;
                  }
                  if (row.tester_email && row.type === 'test-case') {
                    newItem.tester_email = row.tester_email;
                  }
                  
                  const { data, error } = await supabase.from('items').insert([newItem]).select();
                  
                  if (error) throw error;
                  
                  if (data && data[0]) {
                    setItems(prev => [...prev, data[0]]);
                    await createAuditLog(data[0].id, 'create', null, null, `Imported ${data[0].type}: ${data[0].title}`);
                    successCount++;
                  }
                } catch (error) {
                  errors.push(`Error importing "${row.title}": ${error.message}`);
                  errorCount++;
                }
              }
              
              let message = `Import complete!\n\n`;
              message += `✓ Successfully imported: ${successCount} items\n`;
              if (errorCount > 0) {
                message += `✗ Failed: ${errorCount} items\n\n`;
                if (errors.length > 0) {
                  message += `Errors:\n${errors.slice(0, 5).join('\n')}`;
                  if (errors.length > 5) {
                    message += `\n... and ${errors.length - 5} more errors`;
                  }
                }
              }
              
              alert(message);
              setShowImportModal(false);
              setImportFile(null);
              
            } catch (error) {
              console.error('Error importing CSV:', error);
              alert('Error importing CSV: ' + error.message);
            }
          };

          const getItemRelationships = (itemId) => {
            return {
              outgoing: relationships.filter(r => r.from_id === itemId),
              incoming: relationships.filter(r => r.to_id === itemId),
            };
          };

          const reportData = useMemo(() => {
            const allStatuses = [...new Set(items.map(i => i.status))];
            
            const statusByType = {};
            itemTypes.forEach(type => {
              statusByType[type] = {};
              allStatuses.forEach(status => {
                statusByType[type][status] = items.filter(i => i.type === type && i.status === status).length;
              });
            });

            const priorityDist = {};
            priorities.forEach(priority => {
              priorityDist[priority] = items.filter(i => i.priority === priority).length;
            });

            const statusDist = {};
            allStatuses.forEach(status => {
              statusDist[status] = items.filter(i => i.status === status).length;
            });

            const typeDist = {};
            itemTypes.forEach(type => {
              typeDist[type] = items.filter(i => i.type === type).length;
            });

            const requirements = items.filter(i => i.type === 'requirement');
            const testCases = items.filter(i => i.type === 'test-case');
            const requirementsWithTests = requirements.filter(req => 
              relationships.some(r => r.to_id === req.id && items.find(i => i.id === r.from_id && i.type === 'test-case'))
            ).length;
            
            const testCoverage = requirements.length > 0 ? (requirementsWithTests / requirements.length * 100).toFixed(1) : 0;

            const itemsWithRelationships = new Set([...relationships.map(r => r.from_id), ...relationships.map(r => r.to_id)]).size;
            const traceabilityScore = items.length > 0 ? (itemsWithRelationships / items.length * 100).toFixed(1) : 0;

            const ownerWorkload = {};
            items.forEach(item => {
              if (item.owner) {
                ownerWorkload[item.owner] = (ownerWorkload[item.owner] || 0) + 1;
              }
            });

            return {
              statusByType,
              priorityDist,
              statusDist,
              typeDist,
              testCoverage,
              traceabilityScore,
              ownerWorkload,
              totalItems: items.length,
              totalRelationships: relationships.length,
              totalComments: comments.length,
              allStatuses
            };
          }, [items, relationships, comments]);

          // NEW: Folder Tree Component
          const FolderTree = () => {
            const buildFolderTree = () => {
              const folderMap = new Map();
              folders.forEach(folder => {
                folderMap.set(folder.id, { ...folder, children: [], items: [] });
              });

              const rootFolders = [];
              folders.forEach(folder => {
                const node = folderMap.get(folder.id);
                if (folder.parent_id) {
                  const parent = folderMap.get(folder.parent_id);
                  if (parent) parent.children.push(node);
                } else {
                  rootFolders.push(node);
                }
              });

              items.forEach(item => {
                if (item.folder_id) {
                  const folder = folderMap.get(item.folder_id);
                  if (folder) folder.items.push(item);
                }
              });

              return { rootFolders, unorganized: items.filter(i => !i.folder_id) };
            };

            const renderFolder = (folder, depth = 0) => {
              const isExpanded = expandedFolders.has(folder.id);
              const hasContent = folder.children.length > 0 || folder.items.length > 0;

              return h('div', { key: folder.id },
                h('div', {
                  className: `folder-item flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-50 ${isExpanded ? 'bg-gray-50' : ''}`,
                  style: { paddingLeft: `${depth * 16 + 8}px` },
                  onClick: () => hasContent && toggleFolder(folder.id)
                },
                  hasContent && (isExpanded ? h(ChevronDown, { size: 14 }) : h(ChevronRight, { size: 14 })),
                  !hasContent && h('div', { className: 'w-3.5' }),
                  h(isExpanded ? FolderOpen : Folder, { size: 16, className: 'text-yellow-600' }),
                  h('span', { className: 'flex-1 text-sm' }, folder.name),
                  h('span', { className: 'text-xs text-gray-400' }, folder.items.length)
                ),
                isExpanded && hasContent && h('div', {},
                  folder.children.map(child => renderFolder(child, depth + 1)),
                  folder.items.map(item => renderTreeItem(item, depth + 1))
                )
              );
            };

            const renderTreeItem = (item, depth = 0) => {
              const hasChildren = Array.isArray(item.children) && 
                    item.children.length > 0 && 
                    item.children.some(childId => items.find(i => i.id === childId));

              const isExpanded = expandedItems.has(item.id);
              const isSelected = selectedItem?.id === item.id;

              return h('div', { key: item.id },
                h('div', {
                  className: `flex items-center gap-2 px-2 py-1.5 cursor-pointer hover:bg-gray-50 rounded ${isSelected ? 'bg-fresh-50 border-l-4 border-fresh-500' : ''}`,
                  style: { paddingLeft: `${depth * 16 + 8}px` },
                  onClick: () => { setSelectedItem(item); setShowDetailPanel(true); }
                },
                  hasChildren && h('button', {
                    onClick: (e) => { e.stopPropagation(); toggleExpand(item.id); },
                    className: 'p-0'
                  }, isExpanded ? h(ChevronDown, { size: 14 }) : h(ChevronRight, { size: 14 })),
                  !hasChildren && h('div', { className: 'w-3.5' }),
                  h('span', {
                    className: `px-1.5 py-0.5 text-xs rounded ${
                      item.type === 'epic' ? 'bg-purple-100 text-purple-700' :
                      item.type === 'requirement' ? 'bg-blue-100 text-blue-700' :
                      item.type === 'test-case' ? 'bg-green-100 text-green-700' :
                      'bg-red-100 text-red-700'
                    }`
                  }, item.type === 'requirement' && item.level ? item.level.slice(0, 3) : item.type.slice(0, 3)),
                  h('span', { className: 'flex-1 text-sm truncate' }, item.title),
                  item.type !== 'epic' && h('span', {
                    className: `px-1.5 py-0.5 text-xs rounded ${
                      item.status === 'approved' || item.status === 'passed' ? 'bg-green-100 text-green-700' :
                      item.status === 'in-review' || item.status === 'ready-for-test' ? 'bg-yellow-100 text-yellow-700' :
                      item.status === 'rejected' || item.status === 'failed' ? 'bg-red-100 text-red-700' :
                      'bg-gray-100 text-gray-700'
                    }`
                  }, item.status)
                ),
                isExpanded && hasChildren && h('div', {},
                  item.children.map(childId => {
                    const child = items.find(i => i.id === childId);
                    return child ? renderTreeItem(child, depth + 1) : null;
                  })
                )
              );
            };

            const { rootFolders, unorganized } = buildFolderTree();

            return h('div', { className: 'space-y-1' },
              rootFolders.map(folder => renderFolder(folder)),
              unorganized.length > 0 && h('div', { className: 'mt-3 pt-3 border-t' },
                h('div', { className: 'px-2 py-1 text-xs font-semibold text-gray-500 uppercase' }, 'Unorganized'),
                unorganized.map(item => renderTreeItem(item, 0))
              )
            );
          };

          // NEW: Test Run Card Component
          const TestRunCard = ({ run }) => {
            const results = testResults.filter(r => r.test_run_id === run.id);
            const stats = {
              total: results.length,
              passed: results.filter(r => r.status === 'pass').length,
              failed: results.filter(r => r.status === 'fail').length,
              blocked: results.filter(r => r.status === 'block').length,
              pending: results.filter(r => r.status === 'pending').length
            };

            const progress = stats.total > 0 ? ((stats.passed + stats.failed + stats.blocked) / stats.total) * 100 : 0;

            return h('div', {
              className: 'test-run-card bg-white rounded-lg border p-4 hover:shadow-lg cursor-pointer',
              onClick: () => setActiveTestRun(run)
            },
              h('div', { className: 'flex items-start justify-between mb-3' },
                h('div', {},
                  h('h3', { className: 'font-semibold' }, run.name),
                  h('p', { className: 'text-sm text-gray-600 mt-1' }, run.description)
                ),
                h('span', {
                  className: `px-2 py-1 text-xs rounded ${
                    run.status === 'completed' ? 'bg-green-100 text-green-700' :
                    run.status === 'in_progress' ? 'bg-blue-100 text-blue-700' :
                    'bg-gray-100 text-gray-700'
                  }`
                }, run.status)
              ),
              h('div', { className: 'mb-3' },
                h('div', { className: 'h-2 bg-gray-200 rounded-full overflow-hidden' },
                  h('div', {
                    className: 'h-full bg-fresh-500 transition-all',
                    style: { width: `${progress}%` }
                  })
                )
              ),
              h('div', { className: 'grid grid-cols-5 gap-2 text-center text-xs' },
                h('div', {},
                  h('div', { className: 'font-semibold text-gray-700' }, stats.total),
                  h('div', { className: 'text-gray-500' }, 'Total')
                ),
                h('div', {},
                  h('div', { className: 'font-semibold text-green-600' }, stats.passed),
                  h('div', { className: 'text-gray-500' }, 'Pass')
                ),
                h('div', {},
                  h('div', { className: 'font-semibold text-red-600' }, stats.failed),
                  h('div', { className: 'text-gray-500' }, 'Fail')
                ),
                h('div', {},
                  h('div', { className: 'font-semibold text-yellow-600' }, stats.blocked),
                  h('div', { className: 'text-gray-500' }, 'Block')
                ),
                h('div', {},
                  h('div', { className: 'font-semibold text-gray-600' }, stats.pending),
                  h('div', { className: 'text-gray-500' }, 'Pending')
                )
              )
            );
          };

          // NEW: Test Run Execution Modal
          const TestRunExecutionModal = ({ run, onClose }) => {
            const [currentIndex, setCurrentIndex] = useState(0);
            const [notes, setNotes] = useState('');

            const runResults = testResults.filter(r => r.test_run_id === run.id);
            const testCaseIds = runResults.map(r => r.test_case_id);
            const testCases = items.filter(item => testCaseIds.includes(item.id));
            
            if (testCases.length === 0) {
              return h('div', { className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50' },
                h('div', { className: 'bg-white rounded-lg p-6 max-w-md' },
                  h('p', {}, 'No test cases found for this run'),
                  h('button', {
                    onClick: onClose,
                    className: 'mt-4 px-4 py-2 bg-gray-200 rounded hover:bg-gray-300'
                  }, 'Close')
                )
              );
            }

            const currentTestCase = testCases[currentIndex];
            const currentResult = runResults.find(r => r.test_case_id === currentTestCase.id);

            const handleExecute = (status) => {
              handleUpdateTestResult(run.id, currentTestCase.id, status, notes);
              setNotes('');
              if (currentIndex < testCases.length - 1) {
                setCurrentIndex(currentIndex + 1);
              }
            };

            return h('div', {
              className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
              onClick: onClose
            },
              h('div', {
                className: 'bg-white rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto',
                onClick: (e) => e.stopPropagation()
              },
                h('div', { className: 'flex items-center justify-between mb-6' },
                  h('div', {},
                    h('h2', { className: 'text-2xl font-bold' }, run.name),
                    h('p', { className: 'text-sm text-gray-600 mt-1' }, `Test ${currentIndex + 1} of ${testCases.length}`)
                  ),
                  h('button', {
                    onClick: onClose,
                    className: 'text-gray-400 hover:text-gray-600'
                  }, h(X, { size: 24 }))
                ),

                h('div', { className: 'bg-gray-50 rounded-lg p-4 mb-6' },
                  h('div', { className: 'flex items-start justify-between mb-3' },
                    h('h3', { className: 'text-lg font-semibold' }, currentTestCase.title),
                    currentResult?.status && currentResult.status !== 'pending' && h('span', {
                      className: `px-2 py-1 text-xs rounded ${
                        currentResult.status === 'pass' ? 'bg-green-100 text-green-700' :
                        currentResult.status === 'fail' ? 'bg-red-100 text-red-700' :
                        'bg-yellow-100 text-yellow-700'
                      }`
                    }, currentResult.status.toUpperCase())
                  ),
                  h('p', { className: 'text-gray-700 mb-4' }, currentTestCase.description),
                  currentTestCase.test_method && h('div', { className: 'mb-4' },
                    h('h4', { className: 'font-semibold text-sm mb-2' }, 'Test Method:'),
                    h('p', { className: 'text-gray-700 text-sm' }, currentTestCase.test_method)
                  )
                ),

                h('div', { className: 'mb-6' },
                  h('label', { className: 'block text-sm font-medium mb-2' }, 'Execution Notes:'),
                  h('textarea', {
                    value: notes,
                    onChange: (e) => setNotes(e.target.value),
                    className: 'w-full border rounded p-3 h-24',
                    placeholder: 'Add notes about test execution...'
                  })
                ),

                h('div', { className: 'flex gap-3 mb-6' },
                  h('button', {
                    onClick: () => handleExecute('pass'),
                    className: 'flex-1 bg-green-500 text-white px-4 py-3 rounded hover:bg-green-600 font-semibold flex items-center justify-center gap-2'
                  }, h(CheckCircle, { size: 20 }), 'Pass'),
                  h('button', {
                    onClick: () => handleExecute('fail'),
                    className: 'flex-1 bg-red-500 text-white px-4 py-3 rounded hover:bg-red-600 font-semibold flex items-center justify-center gap-2'
                  }, h(XCircle, { size: 20 }), 'Fail'),
                  h('button', {
                    onClick: () => handleExecute('block'),
                    className: 'flex-1 bg-yellow-500 text-white px-4 py-3 rounded hover:bg-yellow-600 font-semibold flex items-center justify-center gap-2'
                  }, h(Clock, { size: 20 }), 'Block')
                ),

                h('div', { className: 'flex items-center justify-between pt-4 border-t' },
                  h('button', {
                    onClick: () => setCurrentIndex(Math.max(0, currentIndex - 1)),
                    disabled: currentIndex === 0,
                    className: 'px-4 py-2 bg-gray-100 rounded hover:bg-gray-200 disabled:opacity-50'
                  }, '← Previous'),
                  h('button', {
                    onClick: () => setCurrentIndex(Math.min(testCases.length - 1, currentIndex + 1)),
                    disabled: currentIndex === testCases.length - 1,
                    className: 'px-4 py-2 bg-gray-100 rounded hover:bg-gray-200 disabled:opacity-50'
                  }, 'Next →')
                )
              )
            );
          };

          // NEW: New Test Run Form
          const NewTestRunForm = ({ onClose }) => {
            const [name, setName] = useState('');
            const [description, setDescription] = useState('');
            const [selectedTests, setSelectedTests] = useState(new Set());

            const testCases = items.filter(item => item.type === 'test-case');

            const handleSubmit = (e) => {
              e.preventDefault();
              if (name && selectedTests.size > 0) {
                handleCreateTestRun({
                  name,
                  description,
                  testCaseIds: Array.from(selectedTests)
                });
              }
            };

            return h('div', {
              className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
              onClick: onClose
            },
              h('div', {
                className: 'bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto',
                onClick: (e) => e.stopPropagation()
              },
                h('h2', { className: 'text-2xl font-bold mb-6' }, 'Create New Test Run'),
                h('form', { onSubmit: handleSubmit },
                  h('div', { className: 'mb-4' },
                    h('label', { className: 'block text-sm font-medium mb-2' }, 'Run Name *'),
                    h('input', {
                      type: 'text',
                      value: name,
                      onChange: (e) => setName(e.target.value),
                      className: 'w-full border rounded p-2',
                      required: true
                    })
                  ),
                  h('div', { className: 'mb-4' },
                    h('label', { className: 'block text-sm font-medium mb-2' }, 'Description'),
                    h('textarea', {
                      value: description,
                      onChange: (e) => setDescription(e.target.value),
                      className: 'w-full border rounded p-2 h-20'
                    })
                  ),
                  h('div', { className: 'mb-6' },
                    h('label', { className: 'block text-sm font-medium mb-2' }, 
                      `Select Test Cases * (${selectedTests.size} selected)`
                    ),
                    h('div', { className: 'border rounded max-h-64 overflow-y-auto' },
                      testCases.length === 0 
                        ? h('div', { className: 'p-4 text-center text-gray-500' }, 'No test cases available')
                        : testCases.map(tc =>
                            h('label', {
                              key: tc.id,
                              className: 'flex items-start gap-3 p-3 hover:bg-gray-50 cursor-pointer border-b'
                            },
                              h('input', {
                                type: 'checkbox',
                                checked: selectedTests.has(tc.id),
                                onChange: () => {
                                  const next = new Set(selectedTests);
                                  if (next.has(tc.id)) next.delete(tc.id);
                                  else next.add(tc.id);
                                  setSelectedTests(next);
                                },
                                className: 'mt-1'
                              }),
                              h('div', {},
                                h('div', { className: 'font-medium' }, tc.title),
                                h('div', { className: 'text-sm text-gray-600' }, tc.description)
                              )
                            )
                          )
                    )
                  ),
                  h('div', { className: 'flex gap-3' },
                    h('button', {
                      type: 'submit',
                      disabled: !name || selectedTests.size === 0,
                      className: 'flex-1 bg-fresh-600 text-white px-4 py-2 rounded hover:bg-fresh-700 disabled:opacity-50'
                    }, 'Create Test Run'),
                    h('button', {
                      type: 'button',
                      onClick: onClose,
                      className: 'flex-1 bg-gray-200 px-4 py-2 rounded hover:bg-gray-300'
                    }, 'Cancel')
                  )
                )
              )
            );
          };

          // All other existing components remain the same...
          const ProjectForm = ({ onSave, onCancel }) => {
            const [formData, setFormData] = useState({
              name: '',
              pid: '',
              project_manager: '',
              lead_engineer: ''
            });

            return h('div', { className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50' },
              h('div', { className: 'bg-white rounded-lg p-6 w-full max-w-md' },
                h('h3', { className: 'text-xl font-bold mb-4' }, 'New Project'),
                h('div', { className: 'space-y-4' },
                  h('div', {},
                    h('label', { className: 'block text-sm font-medium mb-1' }, 'Project Name'),
                    h('input', {
                      type: 'text',
                      value: formData.name,
                      onChange: (e) => setFormData({ ...formData, name: e.target.value }),
                      placeholder: 'e.g., Mobile App v2.0',
                      className: 'w-full border rounded px-3 py-2'
                    })
                  ),
                  h('div', {},
                    h('label', { className: 'block text-sm font-medium mb-1' }, 'Project ID (PID)'),
                    h('input', {
                      type: 'text',
                      value: formData.pid,
                      onChange: (e) => setFormData({ ...formData, pid: e.target.value }),
                      placeholder: 'e.g., MOB-2',
                      className: 'w-full border rounded px-3 py-2'
                    })
                  ),
                  h('div', {},
                    h('label', { className: 'block text-sm font-medium mb-1' }, 'Project Manager'),
                    h('input', {
                      type: 'text',
                      value: formData.project_manager,
                      onChange: (e) => setFormData({ ...formData, project_manager: e.target.value }),
                      className: 'w-full border rounded px-3 py-2'
                    })
                  ),
                  h('div', {},
                    h('label', { className: 'block text-sm font-medium mb-1' }, 'Lead Engineer'),
                    h('input', {
                      type: 'text',
                      value: formData.lead_engineer,
                      onChange: (e) => setFormData({ ...formData, lead_engineer: e.target.value }),
                      className: 'w-full border rounded px-3 py-2'
                    })
                  )
                ),
                h('div', { className: 'flex gap-2 mt-6' },
                  h('button', {
                    onClick: () => onSave(formData),
                    disabled: !formData.name || !formData.pid,
                    className: 'flex-1 bg-fresh-600 text-white px-4 py-2 rounded hover:bg-fresh-700 disabled:bg-gray-300'
                  }, 'Create Project'),
                  h('button', {
                    onClick: onCancel,
                    className: 'flex-1 bg-gray-200 px-4 py-2 rounded hover:bg-gray-300'
                  }, 'Cancel')
                )
              )
            );
          };

          const ProjectSelector = () => {
            const filteredProjects = projects.filter(p => 
              projectSearchTerm === '' || 
              p.name.toLowerCase().includes(projectSearchTerm.toLowerCase()) ||
              p.pid.toLowerCase().includes(projectSearchTerm.toLowerCase())
            );

            return h('div', { className: 'relative' },
              h('button', {
                onClick: () => setShowProjectDropdown(!showProjectDropdown),
                className: 'bg-fresh-700 text-white px-4 py-2 rounded hover:bg-fresh-800 flex items-center gap-2 min-w-[200px]'
              },
                h('span', { className: 'flex-1 text-left truncate' }, 
                  selectedProject ? `${selectedProject.pid} - ${selectedProject.name}` : 'Select Project'
                ),
                h(ChevronDown, { size: 16 })
              ),
              showProjectDropdown && h('div', {
                className: 'absolute top-full mt-1 left-0 bg-white border rounded-lg shadow-lg w-80 max-h-96 overflow-hidden z-50'
              },
                h('div', { className: 'p-2 border-b sticky top-0 bg-white' },
                  h('input', {
                    type: 'text',
                    placeholder: 'Search projects...',
                    value: projectSearchTerm,
                    onChange: (e) => setProjectSearchTerm(e.target.value),
                    className: 'w-full border rounded px-3 py-2',
                    autoFocus: true
                  })
                ),
                h('div', { className: 'max-h-64 overflow-y-auto' },
                  ...filteredProjects.map(project =>
                    h('button', {
                      key: project.id,
                      onClick: () => {
                        setSelectedProject(project);
                        setSelectedItem(null);
                        setEditingItem(null);
                        setShowProjectDropdown(false);
                        setProjectSearchTerm('');
                      },
                      className: `w-full text-left px-4 py-3 hover:bg-gray-50 border-b ${selectedProject?.id === project.id ? 'bg-fresh-50' : ''}`
                    },
                      h('div', { className: 'font-medium' }, project.name),
                      h('div', { className: 'text-sm text-gray-500' }, `PID: ${project.pid}`),
                      project.project_manager && h('div', { className: 'text-xs text-gray-400 mt-1' }, 
                        `PM: ${project.project_manager}${project.lead_engineer ? ` | LE: ${project.lead_engineer}` : ''}`
                      )
                    )
                  ),
                  filteredProjects.length === 0 && h('div', { className: 'px-4 py-3 text-gray-500 text-sm' }, 
                    'No projects found'
                  )
                ),
                h('button', {
                  onClick: () => {
                    setShowProjectForm(true);
                    setShowProjectDropdown(false);
                    setProjectSearchTerm('');
                  },
                  className: 'w-full px-4 py-3 bg-fresh-50 text-fresh-700 hover:bg-fresh-100 font-medium border-t flex items-center justify-center gap-2'
                },
                  h(Plus, { size: 16 }),
                  ' New Project'
                )
              )
            );
          };

          const AuthPrompt = () => {
            return h('div', { className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50' },
              h('div', { className: 'bg-white rounded-lg p-8 w-full max-w-md text-center' },
                h('img', { 
                  src: './Fresh logo - Suisse.png', 
                  alt: 'Fresh Consulting',
                  className: 'h-12 mx-auto mb-6'
                }),
                h('h2', { className: 'text-2xl font-bold mb-4' }, 'Sign In Required'),
                h('p', { className: 'text-gray-600 mb-6' }, 
                  'Please sign in with your Google account to access the Requirements Management System.'
                ),
                h('button', {
                  onClick: handleGoogleSignIn,
                  className: 'w-full bg-white border-2 border-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-50 flex items-center justify-center gap-3 font-medium'
                },
                  h('svg', { width: 20, height: 20, viewBox: '0 0 24 24' },
                    h('path', {
                      fill: '#4285F4',
                      d: 'M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z'
                    }),
                    h('path', {
                      fill: '#34A853',
                      d: 'M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z'
                    }),
                    h('path', {
                      fill: '#FBBC05',
                      d: 'M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z'
                    }),
                    h('path', {
                      fill: '#EA4335',
                      d: 'M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z'
                    })
                  ),
                  ' Sign in with Google'
                )
              )
            );
          };

          const ApprovalModal = () => {
            if (!selectedItem) return null;
            
            const notesRef = useRef(null);
            const isTestCase = selectedItem.type === 'test-case';
            
            const modalTitle = isTestCase ? 'Test Execution Result' : 'Review Item';
            const action1 = isTestCase ? 'pass' : 'approve';
            const action2 = isTestCase ? 'fail' : 'reject';
            const action1Label = isTestCase ? 'Pass' : 'Approve';
            const action2Label = isTestCase ? 'Fail' : 'Reject';
            const notesPlaceholder = isTestCase 
              ? 'Add test execution notes, observations, or issues found...'
              : 'Add any comments about your decision...';
            
            const handleSubmit = () => {
              const notes = notesRef.current?.value || '';
              handleApproveItem(selectedItem.id, approvalAction, notes);
            };

            return h('div', { className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50' },
              h('div', { className: 'bg-white rounded-lg p-6 w-full max-w-md' },
                h('h3', { className: 'text-xl font-bold mb-4' }, modalTitle),
                h('div', { className: 'mb-4 p-3 bg-gray-50 rounded' },
                  h('p', { className: 'text-sm text-gray-600 mb-1' }, 'Item'),
                  h('p', { className: 'font-medium' }, selectedItem.title)
                ),
                h('div', { className: 'mb-4' },
                  h('label', { className: 'block text-sm font-medium mb-2' }, 'Result'),
                  h('div', { className: 'flex gap-3' },
                    h('button', {
                      onClick: () => setApprovalAction(action1),
                      className: `flex-1 p-3 rounded border-2 flex items-center justify-center gap-2 ${
                        approvalAction === action1
                          ? 'border-green-500 bg-green-50 text-green-700' 
                          : 'border-gray-300 hover:border-green-300'
                      }`
                    },
                      h(CheckCircle, { size: 20 }),
                      ` ${action1Label}`
                    ),
                    h('button', {
                      onClick: () => setApprovalAction(action2),
                      className: `flex-1 p-3 rounded border-2 flex items-center justify-center gap-2 ${
                        approvalAction === action2
                          ? 'border-red-500 bg-red-50 text-red-700' 
                          : 'border-gray-300 hover:border-red-300'
                      }`
                    },
                      h(XCircle, { size: 20 }),
                      ` ${action2Label}`
                    )
                  )
                ),
                h('div', { className: 'mb-6' },
                  h('label', { className: 'block text-sm font-medium mb-2' }, 'Notes (Optional)'),
                  h('textarea', {
                    ref: notesRef,
                    defaultValue: approvalNotes,
                    placeholder: notesPlaceholder,
                    className: 'w-full border rounded px-3 py-2 h-24',
                    rows: 3
                  })
                ),
                h('div', { className: 'flex gap-2' },
                  h('button', {
                    onClick: handleSubmit,
                    className: `flex-1 px-4 py-2 rounded font-medium text-white ${
                      approvalAction === action1 ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'
                    }`
                  }, `${approvalAction === action1 ? action1Label : action2Label} Item`),
                  h('button', {
                    onClick: () => {
                      setShowApprovalModal(false);
                      setApprovalNotes('');
                    },
                    className: 'flex-1 bg-gray-200 px-4 py-2 rounded hover:bg-gray-300'
                  }, 'Cancel')
                )
              )
            );
          };

          // Additional components would continue here...
          // For brevity, I'm including the main render return

          const filteredItems = useMemo(() => {
            return items.filter(item => {
              const matchesProject = !selectedProject || item.project_id === selectedProject.id;
              const matchesType = filterType === 'all' || item.type === filterType;
              const matchesStatus = filterStatus === 'all' || item.status === filterStatus;
              const matchesSearch = searchTerm === '' || 
                item.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (item.description && item.description.toLowerCase().includes(searchTerm.toLowerCase()));
              return matchesProject && matchesType && matchesStatus && matchesSearch;
            });
          }, [items, selectedProject, filterType, filterStatus, searchTerm]);

          if (!isConfigured) {
            return h('div', { className: 'h-screen flex items-center justify-center bg-gray-50' },
              h('div', { className: 'bg-white p-8 rounded-lg shadow-lg max-w-2xl w-full' },
                h('img', { 
                  src: './Fresh logo - Suisse.png', 
                  alt: 'Fresh Consulting',
                  className: 'h-12 mx-auto mb-6'
                }),
                h('h1', { className: 'text-3xl font-bold mb-6 text-center' }, 'Requirements Management System'),
                h('p', { className: 'text-gray-600 mb-6' }, 'Connect to your Supabase database to get started.'),
                h('div', { className: 'space-y-4 mb-6' },
                  h('div', {},
                    h('label', { className: 'block text-sm font-medium mb-2' }, 'Supabase Project URL'),
                    h('input', {
                      type: 'text',
                      value: supabaseUrl,
                      onChange: (e) => setSupabaseUrl(e.target.value),
                      placeholder: 'https://your-project.supabase.co',
                      className: 'w-full border rounded px-4 py-2'
                    })
                  ),
                  h('div', {},
                    h('label', { className: 'block text-sm font-medium mb-2' }, 'Supabase Anon Key'),
                    h('input', {
                      type: 'password',
                      value: supabaseKey,
                      onChange: (e) => setSupabaseKey(e.target.value),
                      placeholder: 'Your anon key',
                      className: 'w-full border rounded px-4 py-2'
                    })
                  )
                ),
                h('div', { className: 'space-y-3' },
                  h('button', {
                    onClick: initializeSupabase,
                    disabled: !supabaseUrl || !supabaseKey,
                    className: 'w-full bg-fresh-600 text-white px-4 py-3 rounded hover:bg-fresh-700 disabled:bg-gray-300 font-semibold'
                  }, 'Connect to Supabase'),
                  h('button', {
                    onClick: setupDatabase,
                    className: 'w-full bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300'
                  }, 'Show Database Setup Instructions')
                )
              )
            );
          }

          return h('div', { className: 'h-screen flex flex-col bg-gray-50' },
            // Header
            h('header', { className: 'bg-fresh-600 text-white p-4 shadow flex justify-between items-center' },
              h('div', { className: 'flex items-center gap-4' },
                h('img', { 
                  src: './Fresh logo - Suisse.png', 
                  alt: 'Fresh Consulting',
                  className: 'h-8'
                }),
                h('h1', { className: 'text-2xl font-bold' }, 'Requirements Management'),
                h(ProjectSelector)
              ),
              h('div', { className: 'flex gap-3 items-center' },
                user && h('div', { className: 'flex items-center gap-2 bg-fresh-700 px-3 py-2 rounded' },
                  user.user_metadata?.avatar_url && h('img', {
                    src: user.user_metadata.avatar_url,
                    alt: user.user_metadata?.full_name || user.email,
                    className: 'w-8 h-8 rounded-full'
                  }),
                  h('span', { className: 'text-sm' }, user.user_metadata?.full_name || user.email)
                ),
                // NEW: Help button
                h('a', {
                  href: './quick-start-guide.html',
                  target: '_blank',
                  rel: 'noopener noreferrer',
                  className: 'px-4 py-2 bg-fresh-500 rounded hover:bg-fresh-700 flex items-center gap-2 text-white no-underline',
                  title: 'Open Quick Start Guide'
                }, h(HelpCircle, { size: 18 }), ' Help'),
                h('button', {
                  onClick: () => setShowReports(!showReports),
                  className: `px-4 py-2 rounded flex items-center gap-2 ${showReports ? 'bg-fresh-700' : 'bg-fresh-500 hover:bg-fresh-700'}`
                }, h(TrendingUp, { size: 18 }), showReports ? ' Hide Reports' : ' Show Reports'),
                h('button', {
                  onClick: () => loadData(supabase),
                  className: 'px-4 py-2 bg-fresh-500 rounded hover:bg-fresh-700 flex items-center gap-2'
                }, '🔄'),
                user && h('button', {
                  onClick: handleSignOut,
                  className: 'px-4 py-2 bg-fresh-700 rounded hover:bg-fresh-800 text-sm'
                }, 'Sign Out')
              )
            ),
            // Main content area
            loading ? h('div', { className: 'flex-1 flex items-center justify-center' },
              h('div', { className: 'text-center' },
                h('div', { className: 'animate-spin rounded-full h-12 w-12 border-b-2 border-fresh-600 mx-auto mb-4' }),
                h('p', { className: 'text-gray-600' }, 'Loading data...')
              )
            ) : !selectedProject ? h('div', { className: 'flex-1 flex items-center justify-center' },
              h('div', { className: 'text-center' },
                h(Filter, { size: 64, className: 'mx-auto mb-4 text-gray-300' }),
                h('h2', { className: 'text-2xl font-bold text-gray-700 mb-2' }, 'No Project Selected'),
                h('p', { className: 'text-gray-500 mb-4' }, projects.length === 0 ? 'Create your first project to get started' : 'Select a project from the dropdown above')
              )
            ) : h('div', { className: 'flex-1 flex overflow-hidden' },
              // Sidebar with folder tree and view toggle
              h('div', { className: 'w-80 bg-white border-r flex flex-col' },
                h('div', { className: 'p-4 border-b' },
                  // NEW: View mode toggle
                  h('div', { className: 'flex gap-2 mb-4' },
                    h('button', {
                      onClick: () => setViewMode('tree'),
                      className: `flex-1 px-3 py-2 rounded text-sm font-medium ${viewMode === 'tree' ? 'bg-fresh-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`
                    }, h(List, { size: 16, className: 'inline mr-1' }), 'Items'),
                    h('button', {
                      onClick: () => setViewMode('test-runs'),
                      className: `flex-1 px-3 py-2 rounded text-sm font-medium ${viewMode === 'test-runs' ? 'bg-fresh-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`
                    }, h(Play, { size: 16, className: 'inline mr-1' }), 'Test Runs')
                  ),
                  h('div', { className: 'relative mb-3' },
                    h(Search, { size: 18, className: 'absolute left-3 top-2.5 text-gray-400' }),
                    h('input', {
                      type: 'text',
                      value: searchTerm,
                      onChange: (e) => setSearchTerm(e.target.value),
                      placeholder: 'Search...',
                      className: 'w-full pl-10 pr-3 py-2 border rounded'
                    })
                  ),
                  viewMode === 'tree' && h('div', { className: 'flex gap-2' },
                    ['all', 'epic', 'requirement', 'test-case', 'defect'].map(type =>
                      h('button', {
                        key: type,
                        onClick: () => setFilterType(type),
                        className: `px-2 py-1 rounded text-xs ${filterType === type ? 'bg-fresh-100 text-fresh-700 font-medium' : 'bg-gray-100 hover:bg-gray-200'}`
                      }, type === 'all' ? 'All' : type.split('-')[0])
                    )
                  )
                ),
                h('div', { className: 'flex-1 overflow-y-auto p-4' },
                  viewMode === 'tree' ? h(FolderTree) : h('div', { className: 'space-y-3' },
                    testRuns.filter(run => !selectedProject || run.project_id === selectedProject.id).length === 0 
                      ? h('div', { className: 'text-center py-8 text-gray-500' },
                          h('p', {}, 'No test runs yet')
                        )
                      : testRuns.filter(run => !selectedProject || run.project_id === selectedProject.id).map(run =>
                          h(TestRunCard, { key: run.id, run })
                        )
                  )
                ),
                h('div', { className: 'p-4 border-t' },
                  viewMode === 'tree' 
                    ? h('button', {
                        onClick: () => setShowNewItemForm(true),
                        className: 'w-full bg-fresh-600 text-white px-4 py-2 rounded hover:bg-fresh-700 flex items-center justify-center gap-2'
                      }, h(Plus, { size: 18 }), 'New Item')
                    : h('button', {
                        onClick: () => setShowNewRunForm(true),
                        className: 'w-full bg-fresh-600 text-white px-4 py-2 rounded hover:bg-fresh-700 flex items-center justify-center gap-2'
                      }, h(Play, { size: 18 }), 'New Test Run')
                )
              ),
              // Main detail panel - keep existing code here...
              h('div', { className: 'flex-1 bg-gray-100 p-6 overflow-y-auto' },
                selectedItem && showDetailPanel 
                  ? h('div', { className: 'bg-white rounded-lg shadow-lg p-6 max-w-4xl mx-auto' },
                      h('h2', { className: 'text-2xl font-bold mb-4' }, selectedItem.title),
                      h('p', { className: 'text-gray-700' }, selectedItem.description || 'No description')
                    )
                  : h('div', { className: 'flex items-center justify-center h-full' },
                      h('div', { className: 'text-center text-gray-400' },
                        h(Filter, { size: 64, className: 'mx-auto mb-4 opacity-50' }),
                        h('p', { className: 'text-xl' }, 'Select an item to view details')
                      )
                    )
              )
            ),
            // Modals
            showNewRunForm && h(NewTestRunForm, { onClose: () => setShowNewRunForm(false) }),
            activeTestRun && h(TestRunExecutionModal, { run: activeTestRun, onClose: () => setActiveTestRun(null) }),
            showProjectForm && h(ProjectForm, {
              onSave: handleCreateProject,
              onCancel: () => setShowProjectForm(false)
            }),
            showApprovalModal && h(ApprovalModal),
            showAuthPrompt && !user && h(AuthPrompt)
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(h(RequirementsManager));
        }
        
        initApp();
    </script>
</body>
</html>