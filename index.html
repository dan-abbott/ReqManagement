<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Requirements Management System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createClient } = supabase;

        const RequirementsManager = () => {
            // Supabase setup
            const [supabase, setSupabase] = useState(null);
            const [supabaseUrl, setSupabaseUrl] = useState('');
            const [supabaseKey, setSupabaseKey] = useState('');
            const [isConnected, setIsConnected] = useState(false);
            
            // App state
            const [projects, setProjects] = useState([]);
            const [selectedProject, setSelectedProject] = useState(null);
            const [items, setItems] = useState([]);
            const [relationships, setRelationships] = useState([]);
            const [comments, setComments] = useState([]);
            const [auditLogs, setAuditLogs] = useState([]);
            
            // UI state
            const [selectedItem, setSelectedItem] = useState(null);
            const [editingItem, setEditingItem] = useState(null);
            const [showNewItemForm, setShowNewItemForm] = useState(false);
            const [showApprovalModal, setShowApprovalModal] = useState(false);
            const [approvalAction, setApprovalAction] = useState('approve');
            const [approvalComment, setApprovalComment] = useState('');
            const [newComment, setNewComment] = useState('');
            const [expandedItems, setExpandedItems] = useState(new Set([1]));
            const [filterType, setFilterType] = useState('all');
            const [searchTerm, setSearchTerm] = useState('');
            const [showRelationshipForm, setShowRelationshipForm] = useState(false);
            const [newRelationship, setNewRelationship] = useState({ from: '', to: '', type: 'related-to' });
            const [formData, setFormData] = useState({
                type: 'requirement',
                title: '',
                description: '',
                rationale: '',
                test_method: '',
                status: 'draft',
                priority: 'medium',
                owner: '',
                reviewer_email: '',
                parentId: null
            });

            // Initialize Supabase
            const initializeSupabase = () => {
                try {
                    const client = createClient(supabaseUrl, supabaseKey);
                    setSupabase(client);
                    setIsConnected(true);
                    loadProjects(client);
                } catch (error) {
                    alert('Failed to connect to Supabase: ' + error.message);
                }
            };

            // Database operations
            const loadProjects = async (client) => {
                const { data, error } = await client.from('projects').select('*');
                if (error) {
                    console.error('Error loading projects:', error);
                } else {
                    setProjects(data || []);
                    if (data && data.length > 0) {
                        selectProject(data[0], client);
                    }
                }
            };

            const selectProject = async (project, client = supabase) => {
                setSelectedProject(project);
                await loadProjectData(project.id, client);
            };

            const loadProjectData = async (projectId, client = supabase) => {
                // Load items
                const { data: itemsData, error: itemsError } = await client
                    .from('items')
                    .select('*')
                    .eq('project_id', projectId)
                    .order('id');
                
                if (itemsError) {
                    console.error('Error loading items:', itemsError);
                } else {
                    setItems(itemsData || []);
                }

                // Load relationships
                const { data: relsData, error: relsError } = await client
                    .from('relationships')
                    .select('*')
                    .eq('project_id', projectId);
                
                if (relsError) {
                    console.error('Error loading relationships:', relsError);
                } else {
                    setRelationships(relsData || []);
                }

                // Load comments
                const { data: commentsData, error: commentsError } = await client
                    .from('comments')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (commentsError) {
                    console.error('Error loading comments:', commentsError);
                } else {
                    setComments(commentsData || []);
                }

                // Load audit logs
                const { data: logsData, error: logsError } = await client
                    .from('audit_logs')
                    .select('*')
                    .eq('project_id', projectId)
                    .order('created_at', { ascending: false });
                
                if (logsError) {
                    console.error('Error loading audit logs:', logsError);
                } else {
                    setAuditLogs(logsData || []);
                }
            };

            const createAuditLog = async (itemId, action, details = null) => {
                if (!supabase || !selectedProject) return;
                
                const logEntry = {
                    project_id: selectedProject.id,
                    item_id: itemId,
                    action: action,
                    details: details,
                    user_email: 'current_user@example.com',
                    created_at: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('audit_logs')
                    .insert([logEntry])
                    .select();

                if (error) {
                    console.error('Error creating audit log:', error);
                } else if (data) {
                    setAuditLogs(prev => [data[0], ...prev]);
                }
            };

            const createItem = async () => {
                if (!supabase || !selectedProject) return;

                const newItem = {
                    project_id: selectedProject.id,
                    type: formData.type,
                    title: formData.title,
                    description: formData.description,
                    rationale: formData.rationale || null,
                    test_method: formData.test_method || null,
                    status: formData.status,
                    priority: formData.priority || null,
                    owner: formData.owner || null,
                    reviewer_email: formData.reviewer_email || null,
                    parent_id: formData.parentId,
                    children: [],
                    version: 1
                };

                const { data, error } = await supabase
                    .from('items')
                    .insert([newItem])
                    .select();

                if (error) {
                    alert('Error creating item: ' + error.message);
                } else {
                    setItems([...items, data[0]]);
                    
                    if (formData.parentId) {
                        await createRelationship(data[0].id, formData.parentId, 'parent-child');
                    }
                    
                    await createAuditLog(data[0].id, 'created', { title: formData.title, type: formData.type });
                    
                    setShowNewItemForm(false);
                    resetForm();
                }
            };

            const updateItem = async (itemId, updates) => {
                if (!supabase) return;

                const { data, error } = await supabase
                    .from('items')
                    .update(updates)
                    .eq('id', itemId)
                    .select();

                if (error) {
                    alert('Error updating item: ' + error.message);
                } else {
                    setItems(items.map(item => item.id === itemId ? data[0] : item));
                    await createAuditLog(itemId, 'updated', updates);
                    setEditingItem(null);
                }
            };

            const deleteItem = async (itemId) => {
                if (!supabase) return;
                if (!confirm('Are you sure you want to delete this item?')) return;

                const { error } = await supabase
                    .from('items')
                    .delete()
                    .eq('id', itemId);

                if (error) {
                    alert('Error deleting item: ' + error.message);
                } else {
                    setItems(items.filter(item => item.id !== itemId));
                    await createAuditLog(itemId, 'deleted');
                    if (selectedItem?.id === itemId) {
                        setSelectedItem(null);
                    }
                }
            };

            const handleApprovalAction = async () => {
                if (!selectedItem || !supabase) return;

                const newStatus = approvalAction === 'approve' ? 'approved' : 'rejected';
                
                await updateItem(selectedItem.id, { 
                    status: newStatus,
                    reviewer_email: 'current_user@example.com'
                });

                if (approvalComment.trim()) {
                    await addComment(selectedItem.id, approvalComment);
                }

                await createAuditLog(selectedItem.id, approvalAction, {
                    status: newStatus,
                    comment: approvalComment,
                    reviewer: 'current_user@example.com'
                });

                setShowApprovalModal(false);
                setApprovalComment('');
                setApprovalAction('approve');

                const updated = items.find(i => i.id === selectedItem.id);
                if (updated) {
                    setSelectedItem({ ...updated, status: newStatus });
                }
            };

            const createRelationship = async (fromId, toId, type) => {
                if (!supabase || !selectedProject) return;

                const newRel = {
                    project_id: selectedProject.id,
                    from_item_id: fromId,
                    to_item_id: toId,
                    relationship_type: type
                };

                const { data, error } = await supabase
                    .from('relationships')
                    .insert([newRel])
                    .select();

                if (error) {
                    alert('Error creating relationship: ' + error.message);
                } else {
                    // Reload relationships to ensure both items show the relationship
                    await loadProjectData(selectedProject.id);
                    await createAuditLog(fromId, 'relationship_added', { to: toId, type: type });
                }
            };

            const addComment = async (itemId, text) => {
                if (!supabase || !text.trim()) return;

                const newCommentObj = {
                    item_id: itemId,
                    author: 'current_user@example.com',
                    text: text,
                    created_at: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('comments')
                    .insert([newCommentObj])
                    .select();

                if (error) {
                    alert('Error adding comment: ' + error.message);
                } else {
                    setComments([data[0], ...comments]);
                    setNewComment('');
                }
            };

            const resetForm = () => {
                setFormData({
                    type: 'requirement',
                    title: '',
                    description: '',
                    rationale: '',
                    test_method: '',
                    status: 'draft',
                    priority: 'medium',
                    owner: '',
                    reviewer_email: '',
                    parentId: null
                });
            };

            const getItemRelationships = (itemId) => {
                return relationships.filter(rel => 
                    rel.from_item_id === itemId || rel.to_item_id === itemId
                );
            };

            const getRelatedItem = (relationship, currentItemId) => {
                const relatedId = relationship.from_item_id === currentItemId 
                    ? relationship.to_item_id 
                    : relationship.from_item_id;
                return items.find(item => item.id === relatedId);
            };

            const getItemComments = (itemId) => {
                return comments.filter(c => c.item_id === itemId);
            };

            const getItemAuditLogs = (itemId) => {
                return auditLogs.filter(log => log.item_id === itemId);
            };

            const filteredItems = items.filter(item => {
                const matchesType = filterType === 'all' || item.type === filterType;
                const matchesSearch = item.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                    item.description.toLowerCase().includes(searchTerm.toLowerCase());
                return matchesType && matchesSearch;
            });

            const getStatusColor = (status) => {
                const colors = {
                    'draft': 'bg-gray-200 text-gray-700',
                    'in-review': 'bg-yellow-200 text-yellow-800',
                    'approved': 'bg-green-200 text-green-800',
                    'rejected': 'bg-red-200 text-red-800'
                };
                return colors[status] || 'bg-gray-200 text-gray-700';
            };

            const getPriorityColor = (priority) => {
                const colors = {
                    'low': 'bg-blue-100 text-blue-700',
                    'medium': 'bg-yellow-100 text-yellow-700',
                    'high': 'bg-red-100 text-red-700'
                };
                return colors[priority] || 'bg-gray-100 text-gray-700';
            };

            if (!isConnected) {
                return (
                    <div className="min-h-screen bg-gray-50 p-6">
                        <div className="max-w-md mx-auto bg-white rounded-lg shadow-lg p-8">
                            <h1 className="text-2xl font-bold mb-6">Requirements Management System</h1>
                            <p className="text-gray-600 mb-6">Connect to your Supabase database to get started.</p>
                            
                            <div className="space-y-4 mb-6">
                                <div>
                                    <label className="block text-sm font-medium mb-2">Supabase Project URL</label>
                                    <input
                                        type="text"
                                        value={supabaseUrl}
                                        onChange={(e) => setSupabaseUrl(e.target.value)}
                                        placeholder="https://your-project.supabase.co"
                                        className="w-full border rounded px-4 py-2"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2">Supabase Anon Key</label>
                                    <input
                                        type="password"
                                        value={supabaseKey}
                                        onChange={(e) => setSupabaseKey(e.target.value)}
                                        placeholder="Your anon key"
                                        className="w-full border rounded px-4 py-2"
                                    />
                                </div>
                            </div>
                            
                            <button
                                onClick={initializeSupabase}
                                disabled={!supabaseUrl || !supabaseKey}
                                className="w-full bg-blue-600 text-white px-4 py-3 rounded hover:bg-blue-700 disabled:bg-gray-300 font-semibold"
                            >
                                Connect to Supabase
                            </button>

                            <div className="mt-6 p-4 bg-blue-50 rounded border border-blue-200">
                                <h3 className="font-semibold text-blue-900 mb-2">Need Database Setup?</h3>
                                <p className="text-sm text-blue-800 mb-3">
                                    Run this SQL in your Supabase SQL Editor to create the required tables:
                                </p>
                                <div className="bg-white p-3 rounded border text-xs font-mono overflow-x-auto">
                                    <pre>{`-- Create projects table
CREATE TABLE projects (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create items table
CREATE TABLE items (
    id SERIAL PRIMARY KEY,
    project_id INTEGER REFERENCES projects(id) ON DELETE CASCADE,
    type TEXT NOT NULL,
    title TEXT NOT NULL,
    description TEXT,
    rationale TEXT,
    test_method TEXT,
    status TEXT DEFAULT 'draft',
    priority TEXT,
    owner TEXT,
    reviewer_email TEXT,
    parent_id INTEGER,
    children INTEGER[] DEFAULT '{}',
    version INTEGER DEFAULT 1,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create relationships table
CREATE TABLE relationships (
    id SERIAL PRIMARY KEY,
    project_id INTEGER REFERENCES projects(id) ON DELETE CASCADE,
    from_item_id INTEGER REFERENCES items(id) ON DELETE CASCADE,
    to_item_id INTEGER REFERENCES items(id) ON DELETE CASCADE,
    relationship_type TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create comments table
CREATE TABLE comments (
    id SERIAL PRIMARY KEY,
    item_id INTEGER REFERENCES items(id) ON DELETE CASCADE,
    author TEXT NOT NULL,
    text TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create audit_logs table
CREATE TABLE audit_logs (
    id SERIAL PRIMARY KEY,
    project_id INTEGER REFERENCES projects(id) ON DELETE CASCADE,
    item_id INTEGER REFERENCES items(id) ON DELETE CASCADE,
    action TEXT NOT NULL,
    details JSONB,
    user_email TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Insert a sample project
INSERT INTO projects (name, description) 
VALUES ('Sample Project', 'A sample requirements project');`}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <div className="bg-white border-b px-6 py-4">
                        <div className="flex items-center justify-between">
                            <h1 className="text-2xl font-bold text-gray-800">Requirements Manager</h1>
                            <div className="flex items-center gap-4">
                                <select 
                                    value={selectedProject?.id || ''}
                                    onChange={(e) => {
                                        const proj = projects.find(p => p.id === parseInt(e.target.value));
                                        if (proj) selectProject(proj);
                                    }}
                                    className="border rounded px-3 py-2"
                                >
                                    {projects.map(proj => (
                                        <option key={proj.id} value={proj.id}>{proj.name}</option>
                                    ))}
                                </select>
                                <button
                                    onClick={() => setShowNewItemForm(true)}
                                    className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center gap-2"
                                >
                                    <span>+</span> New Item
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Search and Filter */}
                    <div className="bg-white border-b px-6 py-4">
                        <div className="flex gap-4">
                            <input
                                type="text"
                                placeholder="Search items..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="flex-1 border rounded px-4 py-2"
                            />
                            <select
                                value={filterType}
                                onChange={(e) => setFilterType(e.target.value)}
                                className="border rounded px-4 py-2"
                            >
                                <option value="all">All Types</option>
                                <option value="epic">Epics</option>
                                <option value="requirement">Requirements</option>
                                <option value="test-case">Test Cases</option>
                            </select>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex h-[calc(100vh-180px)]">
                        {/* Items List */}
                        <div className="w-1/2 border-r overflow-y-auto bg-white">
                            <div className="p-4 space-y-2">
                                {filteredItems.map(item => (
                                    <div
                                        key={item.id}
                                        onClick={() => setSelectedItem(item)}
                                        className={`p-4 border rounded cursor-pointer hover:bg-gray-50 ${
                                            selectedItem?.id === item.id ? 'bg-blue-50 border-blue-300' : ''
                                        }`}
                                    >
                                        <div className="flex items-start justify-between mb-2">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className="text-xs px-2 py-1 rounded bg-gray-100">
                                                        {item.type.toUpperCase()}
                                                    </span>
                                                    <span className={`text-xs px-2 py-1 rounded ${getStatusColor(item.status)}`}>
                                                        {item.status}
                                                    </span>
                                                    {item.priority && (
                                                        <span className={`text-xs px-2 py-1 rounded ${getPriorityColor(item.priority)}`}>
                                                            {item.priority}
                                                        </span>
                                                    )}
                                                </div>
                                                <h3 className="font-semibold text-gray-900">{item.title}</h3>
                                                <p className="text-sm text-gray-600 mt-1">{item.description}</p>
                                            </div>
                                        </div>
                                        {item.owner && (
                                            <div className="text-xs text-gray-500">Owner: {item.owner}</div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Item Details */}
                        <div className="w-1/2 overflow-y-auto bg-white p-6">
                            {selectedItem ? (
                                <div className="space-y-6">
                                    <div className="flex items-start justify-between">
                                        <div>
                                            <h2 className="text-2xl font-bold text-gray-900 mb-2">{selectedItem.title}</h2>
                                            <div className="flex gap-2">
                                                <span className={`text-sm px-3 py-1 rounded ${getStatusColor(selectedItem.status)}`}>
                                                    {selectedItem.status}
                                                </span>
                                                {selectedItem.priority && (
                                                    <span className={`text-sm px-3 py-1 rounded ${getPriorityColor(selectedItem.priority)}`}>
                                                        {selectedItem.priority}
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            {selectedItem.status === 'in-review' && (
                                                <button
                                                    onClick={() => setShowApprovalModal(true)}
                                                    className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                                >
                                                    Review
                                                </button>
                                            )}
                                            <button
                                                onClick={() => deleteItem(selectedItem.id)}
                                                className="px-4 py-2 text-red-600 hover:bg-red-50 rounded"
                                            >
                                                Delete
                                            </button>
                                        </div>
                                    </div>

                                    <div className="space-y-4">
                                        <div>
                                            <h3 className="font-semibold mb-2">Description</h3>
                                            <p className="text-gray-700">{selectedItem.description}</p>
                                        </div>

                                        {selectedItem.rationale && (
                                            <div>
                                                <h3 className="font-semibold mb-2">Rationale</h3>
                                                <p className="text-gray-700">{selectedItem.rationale}</p>
                                            </div>
                                        )}

                                        {selectedItem.test_method && (
                                            <div>
                                                <h3 className="font-semibold mb-2">Test Method</h3>
                                                <p className="text-gray-700">{selectedItem.test_method}</p>
                                            </div>
                                        )}

                                        <div className="grid grid-cols-2 gap-4 text-sm">
                                            <div>
                                                <span className="font-semibold">Type:</span> {selectedItem.type}
                                            </div>
                                            <div>
                                                <span className="font-semibold">Owner:</span> {selectedItem.owner || 'Unassigned'}
                                            </div>
                                            <div>
                                                <span className="font-semibold">Version:</span> {selectedItem.version}
                                            </div>
                                            {selectedItem.reviewer_email && (
                                                <div>
                                                    <span className="font-semibold">Reviewer:</span> {selectedItem.reviewer_email}
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* Relationships */}
                                    <div>
                                        <div className="flex items-center justify-between mb-3">
                                            <h3 className="font-semibold">Relationships</h3>
                                            <button
                                                onClick={() => {
                                                    setNewRelationship({ ...newRelationship, from: selectedItem.id });
                                                    setShowRelationshipForm(true);
                                                }}
                                                className="text-sm px-3 py-1 bg-gray-200 rounded hover:bg-gray-300"
                                            >
                                                + Add Relationship
                                            </button>
                                        </div>
                                        <div className="space-y-2">
                                            {getItemRelationships(selectedItem.id).map((rel, idx) => {
                                                const relatedItem = getRelatedItem(rel, selectedItem.id);
                                                const isOutgoing = rel.from_item_id === selectedItem.id;
                                                return (
                                                    <div key={idx} className="p-3 bg-gray-50 rounded border">
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded">
                                                                {rel.relationship_type}
                                                            </span>
                                                            <span className="text-sm text-gray-600">
                                                                {isOutgoing ? '→' : '←'}
                                                            </span>
                                                            <span className="text-sm font-medium">
                                                                {relatedItem?.title || `Item #${isOutgoing ? rel.to_item_id : rel.from_item_id}`}
                                                            </span>
                                                        </div>
                                                        {relatedItem && (
                                                            <p className="text-xs text-gray-500 mt-1">{relatedItem.description}</p>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                            {getItemRelationships(selectedItem.id).length === 0 && (
                                                <p className="text-sm text-gray-500">No relationships defined</p>
                                            )}
                                        </div>
                                    </div>

                                    {/* Comments */}
                                    <div>
                                        <h3 className="font-semibold mb-3">Comments</h3>
                                        <div className="space-y-3 mb-4">
                                            {getItemComments(selectedItem.id).map(comment => (
                                                <div key={comment.id} className="p-3 bg-gray-50 rounded">
                                                    <div className="flex items-center justify-between mb-1">
                                                        <span className="font-medium text-sm">{comment.author}</span>
                                                        <span className="text-xs text-gray-500">
                                                            {new Date(comment.created_at).toLocaleString()}
                                                        </span>
                                                    </div>
                                                    <p className="text-sm text-gray-700">{comment.text}</p>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="flex gap-2">
                                            <input
                                                type="text"
                                                placeholder="Add a comment..."
                                                value={newComment}
                                                onChange={(e) => setNewComment(e.target.value)}
                                                className="flex-1 border rounded px-3 py-2 text-sm"
                                            />
                                            <button
                                                onClick={() => addComment(selectedItem.id, newComment)}
                                                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                            >
                                                Add
                                            </button>
                                        </div>
                                    </div>

                                    {/* Audit Log */}
                                    <div>
                                        <h3 className="font-semibold mb-3">Activity History</h3>
                                        <div className="space-y-2">
                                            {getItemAuditLogs(selectedItem.id).slice(0, 10).map((log, idx) => (
                                                <div key={idx} className="text-sm p-2 bg-gray-50 rounded">
                                                    <div className="flex items-center justify-between">
                                                        <span className="font-medium">{log.action}</span>
                                                        <span className="text-xs text-gray-500">
                                                            {new Date(log.created_at).toLocaleString()}
                                                        </span>
                                                    </div>
                                                    {log.details && (
                                                        <div className="text-xs text-gray-600 mt-1">
                                                            {JSON.stringify(log.details)}
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="text-center text-gray-500 mt-12">
                                    Select an item to view details
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Approval Modal */}
                    {showApprovalModal && selectedItem && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
                                <h2 className="text-xl font-bold mb-4">Review Item</h2>
                                <div className="mb-4">
                                    <h3 className="font-semibold">{selectedItem.title}</h3>
                                    <p className="text-sm text-gray-600 mt-1">{selectedItem.description}</p>
                                </div>
                                
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-2">Action</label>
                                    <div className="flex gap-4">
                                        <label className="flex items-center">
                                            <input
                                                type="radio"
                                                value="approve"
                                                checked={approvalAction === 'approve'}
                                                onChange={(e) => setApprovalAction(e.target.value)}
                                                className="mr-2"
                                            />
                                            <span className="text-green-700">Approve</span>
                                        </label>
                                        <label className="flex items-center">
                                            <input
                                                type="radio"
                                                value="reject"
                                                checked={approvalAction === 'reject'}
                                                onChange={(e) => setApprovalAction(e.target.value)}
                                                className="mr-2"
                                            />
                                            <span className="text-red-700">Reject</span>
                                        </label>
                                    </div>
                                </div>

                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-2">
                                        Comment {approvalAction === 'reject' ? '(Required)' : '(Optional)'}
                                    </label>
                                    <textarea
                                        value={approvalComment}
                                        onChange={(e) => setApprovalComment(e.target.value)}
                                        placeholder={`Add ${approvalAction === 'reject' ? 'reason for rejection' : 'review comments'}...`}
                                        className="w-full border rounded px-3 py-2 h-24"
                                    />
                                </div>

                                <div className="flex gap-3 justify-end">
                                    <button
                                        onClick={() => {
                                            setShowApprovalModal(false);
                                            setApprovalComment('');
                                            setApprovalAction('approve');
                                        }}
                                        className="px-4 py-2 border rounded hover:bg-gray-100"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleApprovalAction}
                                        disabled={approvalAction === 'reject' && !approvalComment.trim()}
                                        className={`px-4 py-2 rounded text-white disabled:bg-gray-300 ${
                                            approvalAction === 'approve' 
                                                ? 'bg-green-600 hover:bg-green-700' 
                                                : 'bg-red-600 hover:bg-red-700'
                                        }`}
                                    >
                                        {approvalAction === 'approve' ? 'Approve' : 'Reject'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* New Item Form Modal */}
                    {showNewItemForm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                                <h2 className="text-xl font-bold mb-4">Create New Item</h2>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Type</label>
                                        <select
                                            value={formData.type}
                                            onChange={(e) => setFormData({ ...formData, type: e.target.value })}
                                            className="w-full border rounded px-3 py-2"
                                        >
                                            <option value="epic">Epic</option>
                                            <option value="requirement">Requirement</option>
                                            <option value="test-case">Test Case</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Title</label>
                                        <input
                                            type="text"
                                            value={formData.title}
                                            onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                                            className="w-full border rounded px-3 py-2"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Description</label>
                                        <textarea
                                            value={formData.description}
                                            onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                                            className="w-full border rounded px-3 py-2 h-24"
                                        />
                                    </div>

                                    {formData.type === 'requirement' && (
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Rationale</label>
                                            <textarea
                                                value={formData.rationale}
                                                onChange={(e) => setFormData({ ...formData, rationale: e.target.value })}
                                                className="w-full border rounded px-3 py-2 h-20"
                                                placeholder="Why is this requirement needed?"
                                            />
                                        </div>
                                    )}

                                    {formData.type === 'test-case' && (
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Test Method</label>
                                            <textarea
                                                value={formData.test_method}
                                                onChange={(e) => setFormData({ ...formData, test_method: e.target.value })}
                                                className="w-full border rounded px-3 py-2 h-20"
                                                placeholder="How should this be tested?"
                                            />
                                        </div>
                                    )}

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Status</label>
                                            <select
                                                value={formData.status}
                                                onChange={(e) => setFormData({ ...formData, status: e.target.value })}
                                                className="w-full border rounded px-3 py-2"
                                            >
                                                <option value="draft">Draft</option>
                                                <option value="in-review">In Review</option>
                                                <option value="approved">Approved</option>
                                                <option value="rejected">Rejected</option>
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-1">Priority</label>
                                            <select
                                                value={formData.priority}
                                                onChange={(e) => setFormData({ ...formData, priority: e.target.value })}
                                                className="w-full border rounded px-3 py-2"
                                            >
                                                <option value="low">Low</option>
                                                <option value="medium">Medium</option>
                                                <option value="high">High</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Owner (Email)</label>
                                        <input
                                            type="email"
                                            value={formData.owner}
                                            onChange={(e) => setFormData({ ...formData, owner: e.target.value })}
                                            className="w-full border rounded px-3 py-2"
                                            placeholder="owner@example.com"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Reviewer (Email)</label>
                                        <input
                                            type="email"
                                            value={formData.reviewer_email}
                                            onChange={(e) => setFormData({ ...formData, reviewer_email: e.target.value })}
                                            className="w-full border rounded px-3 py-2"
                                            placeholder="reviewer@example.com"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Parent Item (Optional)</label>
                                        <select
                                            value={formData.parentId || ''}
                                            onChange={(e) => setFormData({ ...formData, parentId: e.target.value ? parseInt(e.target.value) : null })}
                                            className="w-full border rounded px-3 py-2"
                                        >
                                            <option value="">None</option>
                                            {items.map(item => (
                                                <option key={item.id} value={item.id}>
                                                    {item.title} ({item.type})
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                </div>

                                <div className="flex gap-3 justify-end mt-6">
                                    <button
                                        onClick={() => {
                                            setShowNewItemForm(false);
                                            resetForm();
                                        }}
                                        className="px-4 py-2 border rounded hover:bg-gray-100"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={createItem}
                                        className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                    >
                                        Create Item
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Relationship Form Modal */}
                    {showRelationshipForm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
                                <h2 className="text-xl font-bold mb-4">Add Relationship</h2>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Relationship Type</label>
                                        <select
                                            value={newRelationship.type}
                                            onChange={(e) => setNewRelationship({ ...newRelationship, type: e.target.value })}
                                            className="w-full border rounded px-3 py-2"
                                        >
                                            <option value="related-to">Related To</option>
                                            <option value="depends-on">Depends On</option>
                                            <option value="tests">Tests</option>
                                            <option value="parent-child">Parent-Child</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Target Item</label>
                                        <select
                                            value={newRelationship.to || ''}
                                            onChange={(e) => setNewRelationship({ ...newRelationship, to: parseInt(e.target.value) })}
                                            className="w-full border rounded px-3 py-2"
                                        >
                                            <option value="">Select an item...</option>
                                            {items.filter(item => item.id !== newRelationship.from).map(item => (
                                                <option key={item.id} value={item.id}>
                                                    {item.title} ({item.type})
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                </div>

                                <div className="flex gap-3 justify-end mt-6">
                                    <button
                                        onClick={() => {
                                            setShowRelationshipForm(false);
                                            setNewRelationship({ from: '', to: '', type: 'related-to' });
                                        }}
                                        className="px-4 py-2 border rounded hover:bg-gray-100"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={() => {
                                            if (newRelationship.from && newRelationship.to) {
                                                createRelationship(newRelationship.from, newRelationship.to, newRelationship.type);
                                                setShowRelationshipForm(false);
                                                setNewRelationship({ from: '', to: '', type: 'related-to' });
                                            }
                                        }}
                                        disabled={!newRelationship.to}
                                        className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-300"
                                    >
                                        Add Relationship
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<RequirementsManager />, document.getElementById('root'));
    </script>
</body>
</html>
